# 如何给协作者合并 PR 权限

本文档详细说明如何授予协作者合并 Pull Request 的权限。

## 📋 快速步骤

### 步骤 1：授予 Write 权限（必需）

1. 进入仓库 **Settings** → **Collaborators**
2. 找到协作者（或添加新协作者）
3. 将权限设置为 **Write** 或更高
4. 保存更改

### 步骤 2：检查分支保护规则

如果主分支有保护规则，协作者需要满足条件才能合并：
- ✅ 通过所有 CI 检查
- ✅ 获得审查者审批
- ✅ 解决所有评论
- ✅ 分支同步

## 🔐 权限级别与合并 PR

### 权限级别对比

| 权限级别 | 创建 PR | 审查 PR | 合并 PR | 直接推送 |
|---------|---------|---------|---------|---------|
| **Read** | ✅ | ✅ | ❌ | ❌ |
| **Triage** | ✅ | ✅ | ❌ | ❌ |
| **Write** | ✅ | ✅ | ✅* | ✅ |
| **Maintain** | ✅ | ✅ | ✅* | ✅ |
| **Admin** | ✅ | ✅ | ✅* | ✅ |

*注意：如果分支有保护规则，仍然需要满足条件才能合并。

## 📝 详细操作步骤

### 方法 1：添加新协作者并授予合并权限

#### 步骤 1：进入协作者设置

1. 打开 GitHub 仓库页面
2. 点击 **Settings**（设置）
3. 点击左侧菜单的 **Collaborators**

#### 步骤 2：添加协作者

1. 点击 **Add people**（添加人员）
2. 输入用户名（如 `dujiaoai`）
3. 选择权限级别：**Write**（或更高）
4. 点击 **Add [username] to this repository**

#### 步骤 3：等待用户接受邀请

- GitHub 会发送邀请邮件
- 用户接受邀请后，权限生效

### 方法 2：修改现有协作者权限

#### 步骤 1：找到协作者

1. 进入 **Settings** → **Collaborators**
2. 在协作者列表中找到用户

#### 步骤 2：修改权限

1. 点击用户权限下拉菜单
2. 选择 **Write**（或更高权限）
3. 权限立即生效

## 🛡️ 分支保护规则的影响

### 情况 1：主分支没有保护规则

**协作者权限**：**Write** 或更高

**可以**：
- ✅ 直接合并 PR（无需审批）
- ✅ 直接推送代码到主分支
- ✅ 创建和删除分支

**注意**：虽然可以直接合并，但建议：
- ✅ 仍然进行代码审查
- ✅ 确保 CI 检查通过
- ✅ 遵循团队工作流程

### 情况 2：主分支有保护规则

**协作者权限**：**Write** 或更高

**仍然需要满足**：
- ✅ **通过所有 CI 检查**（必需）
- ✅ **获得审查者审批**（必需）
- ✅ **CODEOWNERS 审批**（如果配置了）
- ✅ **解决所有评论**（必需）
- ✅ **分支同步**（必需）

**即使有 Write 权限，也不能绕过保护规则！**

## 🔧 配置 CODEOWNERS（可选）

如果希望协作者自动分配为审查者：

### 更新 CODEOWNERS 文件

编辑 `.github/CODEOWNERS`：

```codeowners
# 全局默认审查者
* @gzhidao1011 @dujiaoai

# 特定路径
apps/web/ @gzhidao1011 @dujiaoai
packages/utils/ @gzhidao1011 @dujiaoai
```

### CODEOWNERS 的作用

- ✅ 自动分配审查者
- ✅ 如果配置了分支保护规则，CODEOWNERS 指定的审查者必须审批
- ❌ **不影响合并权限**（权限级别决定）

## ✅ 验证合并权限

### 验证步骤

1. **检查权限级别**：
   - 进入 **Settings** → **Collaborators**
   - 确认用户权限为 **Write** 或更高

2. **测试合并 PR**：
   - 创建一个测试 PR
   - 确认用户可以点击 "Merge pull request" 按钮
   - 如果分支有保护规则，确认满足所有条件

3. **检查分支保护规则**：
   - 进入 **Settings** → **Branches**
   - 查看主分支的保护规则
   - 确认合并要求

## 🎯 常见场景

### 场景 1：给团队成员合并权限

**操作**：
1. 添加为协作者
2. 授予 **Write** 权限
3. 配置 CODEOWNERS（如果需要）

**结果**：
- ✅ 可以合并 PR
- ✅ 如果分支有保护规则，需要满足条件

### 场景 2：给外部贡献者合并权限

**操作**：
1. 添加为协作者
2. 授予 **Write** 权限
3. 配置 CODEOWNERS（如果需要）

**注意**：
- ⚠️ 通常外部贡献者不需要合并权限
- ⚠️ 建议只给核心维护者合并权限

### 场景 3：临时合并权限

**操作**：
1. 授予 **Write** 权限
2. 完成任务后，可以降低权限或移除

**注意**：
- ⚠️ 定期审查协作者列表
- ⚠️ 移除不再需要的协作者

## 🚫 权限限制说明

### 个人账户私有仓库

**限制**：
- ❌ 分支保护规则不生效（GitHub 限制）
- ✅ 但仍然建议手动检查：
  - CI 检查通过
  - 获得审查者审批
  - 解决所有评论

### 公开仓库

**限制**：
- ✅ 分支保护规则可以生效
- ✅ 可以配置严格的合并要求
- ✅ 协作者必须满足所有条件

## 📊 权限配置建议

### 小型团队（2-5 人）

**推荐配置**：
- 所有成员：**Write** 权限
- 主分支：配置保护规则
- CODEOWNERS：所有成员

### 中型团队（5-20 人）

**推荐配置**：
- 核心成员：**Write** 权限
- 新成员：**Read** 权限（通过 PR 贡献）
- 主分支：严格保护规则
- CODEOWNERS：核心成员

### 大型团队（20+ 人）

**推荐配置**：
- 维护者：**Maintain** 权限
- 核心贡献者：**Write** 权限
- 贡献者：**Read** 权限
- 主分支：严格保护规则
- CODEOWNERS：维护者和核心贡献者

## 🔍 故障排除

### 问题 1：协作者无法合并 PR

**可能原因**：
1. 权限级别不够（需要 Write 或更高）
2. 分支有保护规则，未满足条件
3. PR 未通过 CI 检查
4. 未获得审查者审批

**解决方案**：
1. 检查权限级别
2. 检查分支保护规则
3. 确保所有 CI 检查通过
4. 确保获得审查者审批

### 问题 2：权限已设置但仍无法合并

**可能原因**：
1. 分支保护规则阻止合并
2. CODEOWNERS 要求未满足
3. PR 有未解决的评论

**解决方案**：
1. 检查分支保护规则设置
2. 确保 CODEOWNERS 审批完成
3. 解决所有 PR 评论

### 问题 3：如何撤销合并权限

**操作**：
1. 进入 **Settings** → **Collaborators**
2. 找到用户
3. 将权限降低为 **Read** 或 **Triage**
4. 或直接移除协作者

## 📚 相关文档

- [添加协作者指南](./ADD_COLLABORATOR.md)
- [分支保护规则配置](./BRANCH_PROTECTION.md)
- [CODEOWNERS 配置](./CODEOWNERS)
- [如何合并 PR](./HOW_TO_MERGE_PR.md)

## 💡 最佳实践

### 权限管理

1. ✅ **最小权限原则**：只授予必要的权限
2. ✅ **定期审查**：定期检查协作者列表
3. ✅ **使用分支保护**：配置分支保护规则
4. ✅ **文档记录**：记录权限分配原因

### 合并流程

1. ✅ **代码审查**：所有 PR 都应该经过审查
2. ✅ **CI 检查**：确保所有检查通过
3. ✅ **遵循规范**：使用统一的合并方式（如 Squash and merge）
4. ✅ **及时合并**：审查通过后及时合并

## ❓ 常见问题

### Q: Write 权限可以合并所有分支的 PR 吗？

**A**: 
- ✅ 可以合并非保护分支的 PR
- ✅ 可以合并保护分支的 PR（如果满足保护规则）
- ❌ 不能绕过分支保护规则

### Q: 如何只允许特定协作者合并 PR？

**A**: 
1. 只给这些协作者 **Write** 权限
2. 其他协作者设置为 **Read** 或 **Triage**
3. 配置分支保护规则，要求审查者审批

### Q: 协作者可以合并自己的 PR 吗？

**A**: 
- ✅ 如果分支没有保护规则：可以
- ✅ 如果分支有保护规则：需要其他审查者审批（通常不允许自己审批）

### Q: 如何临时授予合并权限？

**A**: 
1. 授予 **Write** 权限
2. 完成任务后，降低权限或移除
