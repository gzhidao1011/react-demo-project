# ==================== Docker é•œåƒè‡ªåŠ¨æž„å»ºå’ŒæŽ¨é€ ====================
# 
# è§¦å‘æ¡ä»¶ï¼š
#   - æŽ¨é€åˆ° main åˆ†æ”¯çš„ services ç›®å½•å˜æ›´
#   - æ‰‹åŠ¨è§¦å‘
#   - åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾ (v*)
#
# é…ç½®æ­¥éª¤ï¼š
#   1. åœ¨ GitHub ä»“åº“ Settings -> Secrets and variables -> Actions æ·»åŠ ï¼š
#      - DOCKERHUB_USERNAME: ä½ çš„ Docker Hub ç”¨æˆ·å
#      - DOCKERHUB_TOKEN: Docker Hub Access Tokenï¼ˆåœ¨ Docker Hub è´¦æˆ·è®¾ç½®ä¸­åˆ›å»ºï¼‰
#
# ================================================================

name: Build and Push Docker Images

on:
  push:
    branches:
      - main
    paths:
      - 'services/**'
      - 'apps/**'
      - 'packages/**'
      - 'docker/**'
      - 'docker-compose.yml'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'turbo.json'
    tags:
      - 'v*'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      tag:
        description: 'é•œåƒæ ‡ç­¾ (é»˜è®¤: latest)'
        required: false
        default: 'latest'

env:
  # Docker Hub ç”¨æˆ·åï¼ˆä»Ž secrets èŽ·å–ï¼‰
  REGISTRY: docker.io
  # é•œåƒå‰ç¼€
  IMAGE_PREFIX: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  # è¿è¡Œæµ‹è¯•ï¼ˆå¿…é¡»åœ¨æž„å»ºä¹‹å‰é€šè¿‡ï¼‰
  test:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. è®¾ç½® Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # 3. å¯ç”¨ Corepackï¼ˆpnpmï¼‰
      - name: Enable Corepack
        run: corepack enable && corepack prepare pnpm@10.28.0 --activate

      # 4. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 5. è¿è¡Œç±»åž‹æ£€æŸ¥
      - name: Type check
        run: pnpm check:types

      # 6. è¿è¡Œä»£ç æ£€æŸ¥
      - name: Lint and format check
        run: pnpm check

      # 7. è¿è¡Œæµ‹è¯•
      - name: Run tests
        run: pnpm test

      # 8. ç”Ÿæˆæµ‹è¯•è¦†ç›–çŽ‡æŠ¥å‘Šï¼ˆå¯é€‰ï¼‰
      - name: Generate test coverage
        run: pnpm test:coverage
        continue-on-error: true

      # 9. ä¸Šä¼ è¦†ç›–çŽ‡æŠ¥å‘Šï¼ˆå¯é€‰ï¼Œéœ€è¦é…ç½® codecov æˆ–å…¶ä»–æœåŠ¡ï¼‰
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: |
            **/coverage/**
          retention-days: 7

  # æž„å»º Java å¾®æœåŠ¡
  build-java-services:
    runs-on: ubuntu-latest
    needs: test
    
    strategy:
      matrix:
        service:
          - name: user-service
            context: ./services/user-service
          - name: order-service
            context: ./services/order-service
          - name: api-gateway
            context: ./services/api-gateway

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. è®¾ç½® JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # 3. æž„å»º Java é¡¹ç›®
      - name: Build with Maven
        working-directory: ./services
        run: mvn clean package -DskipTests -pl ${{ matrix.service.name }} -am -B

      # 4. è®¾ç½® Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 5. ç™»å½• Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 6. æå–å…ƒæ•°æ®ï¼ˆæ ‡ç­¾ã€ç‰ˆæœ¬ç­‰ï¼‰
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/${{ matrix.service.name }}
          tags: |
            # åˆ†æ”¯å
            type=ref,event=branch
            # ç‰ˆæœ¬æ ‡ç­¾
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            # latest æ ‡ç­¾ï¼ˆä»… main åˆ†æ”¯ï¼‰
            type=raw,value=latest,enable={{is_default_branch}}
            # æ‰‹åŠ¨è¾“å…¥çš„æ ‡ç­¾
            type=raw,value=${{ github.event.inputs.tag }},enable=${{ github.event_name == 'workflow_dispatch' }}
            # commit SHA
            type=sha,prefix=

      # 7. æž„å»ºå¹¶æŽ¨é€ Docker é•œåƒ
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.context }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 8. è¾“å‡ºé•œåƒä¿¡æ¯
      - name: Image digest
        run: |
          echo "Image: ${{ env.IMAGE_PREFIX }}/${{ matrix.service.name }}"
          echo "Tags: ${{ steps.meta.outputs.tags }}"

  # æž„å»ºå‰ç«¯åº”ç”¨
  build-frontend-apps:
    runs-on: ubuntu-latest
    needs: test
    
    strategy:
      matrix:
        app:
          - name: web
            dockerfile: ./apps/web/Dockerfile
          - name: docs
            dockerfile: ./apps/docs/Dockerfile
          - name: storybook
            dockerfile: ./apps/storybook/Dockerfile

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. è®¾ç½® Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # 3. å¯ç”¨ Corepackï¼ˆpnpmï¼‰
      - name: Enable Corepack
        run: corepack enable && corepack prepare pnpm@10.28.0 --activate

      # 4. è®¾ç½® Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 5. ç™»å½• Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 6. æå–å…ƒæ•°æ®ï¼ˆæ ‡ç­¾ã€ç‰ˆæœ¬ç­‰ï¼‰
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/${{ matrix.app.name }}
          tags: |
            # åˆ†æ”¯å
            type=ref,event=branch
            # ç‰ˆæœ¬æ ‡ç­¾
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            # latest æ ‡ç­¾ï¼ˆä»… main åˆ†æ”¯ï¼‰
            type=raw,value=latest,enable={{is_default_branch}}
            # æ‰‹åŠ¨è¾“å…¥çš„æ ‡ç­¾
            type=raw,value=${{ github.event.inputs.tag }},enable=${{ github.event_name == 'workflow_dispatch' }}
            # commit SHA
            type=sha,prefix=

      # 7. æž„å»ºå¹¶æŽ¨é€ Docker é•œåƒ
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.app.dockerfile }}
          build-args: |
            APP_NAME=${{ matrix.app.name }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 8. è¾“å‡ºé•œåƒä¿¡æ¯
      - name: Image digest
        run: |
          echo "Image: ${{ env.IMAGE_PREFIX }}/${{ matrix.app.name }}"
          echo "Tags: ${{ steps.meta.outputs.tags }}"

  # æž„å»ºå®ŒæˆåŽçš„é€šçŸ¥
  notify:
    needs: [build-java-services, build-frontend-apps]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Docker Images Published ðŸ³" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Java å¾®æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Image |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| user-service | \`${{ secrets.DOCKERHUB_USERNAME }}/user-service\` |" >> $GITHUB_STEP_SUMMARY
          echo "| order-service | \`${{ secrets.DOCKERHUB_USERNAME }}/order-service\` |" >> $GITHUB_STEP_SUMMARY
          echo "| api-gateway | \`${{ secrets.DOCKERHUB_USERNAME }}/api-gateway\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å‰ç«¯åº”ç”¨" >> $GITHUB_STEP_SUMMARY
          echo "| App | Image |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| web | \`${{ secrets.DOCKERHUB_USERNAME }}/web\` |" >> $GITHUB_STEP_SUMMARY
          echo "| docs | \`${{ secrets.DOCKERHUB_USERNAME }}/docs\` |" >> $GITHUB_STEP_SUMMARY
          echo "| storybook | \`${{ secrets.DOCKERHUB_USERNAME }}/storybook\` |" >> $GITHUB_STEP_SUMMARY
