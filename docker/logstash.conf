input {
  # TCP输入 - 从应用接收JSON日志
  tcp {
    port => 5000
    codec => json_lines {
      charset => "UTF-8"
    }
    type => "app-logs"
  }
}

filter {
  if [type] == "app-logs" {
    # 解析应用名和环境
    if [application] {
      mutate {
        add_field => {
          "[@metadata][index_prefix]" => "logs-%{[application]}"
          "[@metadata][index_date]" => "%{+YYYY.MM.dd}"
        }
      }
    } else {
      mutate {
        add_field => {
          "[@metadata][index_prefix]" => "logs-unknown"
          "[@metadata][index_date]" => "%{+YYYY.MM.dd}"
        }
      }
    }
    
    # 提取关键字段便于搜索
    if [message] {
      grok {
        match => {
          "message" => "(?<log_message>.*)"
        }
        overwrite => [ "message" ]
      }
    }
    
    # 增强错误日志
    if [level] == "ERROR" or [level] == "WARN" {
      mutate {
        add_tag => [ "alert" ]
        add_field => { "severity" => "high" }
      }
      
      # 提取堆栈跟踪
      if [stacktrace] {
        mutate {
          add_tag => [ "has_stacktrace" ]
        }
      }
    }
    
    # 时间戳处理
    if [@timestamp] {
      date {
        match => [ "@timestamp", "ISO8601" ]
      }
    }
  }
}

output {
  # 输出到Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "%{[@metadata][index_prefix]}-%{[@metadata][index_date]}"
    document_type => "_doc"
    codec => json
  }
  
  # 控制台输出（调试用）
  if [@metadata][debug] {
    stdout {
      codec => rubydebug
    }
  }
}
