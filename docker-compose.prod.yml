# ==================== 生产环境 Docker Compose ====================
# 使用远程镜像仓库的镜像，无需本地构建
#
# 使用前请修改下方的 REGISTRY 变量为你的镜像仓库地址
# 例如：
#   - Docker Hub: gzhidao1010
#   - 阿里云: registry.cn-hangzhou.aliyuncs.com/your-namespace
#   - GitHub: ghcr.io/gzhidao1010
#
# 使用方法：
#   docker-compose -f docker-compose.prod.yml up -d
#
# ================================================================

# 定义镜像仓库地址（使用前请修改）
x-registry: &registry "gzhidao1010"  # 修改为你的 Docker Hub 用户名或其他仓库地址

services:
  # ==================== 基础设施服务 ====================
  
  mysql:
    image: mysql:8.0
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root123}
      TZ: Asia/Shanghai
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root123}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - microservices-network
    restart: unless-stopped

  nacos:
    image: nacos/nacos-server:v2.3.0
    container_name: nacos
    environment:
      - MODE=standalone
      - PREFER_HOST_MODE=hostname
      - SPRING_DATASOURCE_PLATFORM=mysql
      - MYSQL_SERVICE_HOST=mysql
      - MYSQL_SERVICE_PORT=3306
      - MYSQL_SERVICE_DB_NAME=nacos
      - MYSQL_SERVICE_USER=root
      - MYSQL_SERVICE_PASSWORD=${MYSQL_ROOT_PASSWORD:-root123}
      - MYSQL_SERVICE_DB_PARAM=characterEncoding=utf8&connectTimeout=10000&socketTimeout=30000&autoReconnect=true&useSSL=false&allowPublicKeyRetrieval=true
      - NACOS_AUTH_ENABLE=false
      - JVM_XMS=256m
      - JVM_XMX=512m
    ports:
      - "8848:8848"
      - "9848:9848"
      - "9849:9849"
    volumes:
      - nacos-data:/home/nacos/data
      - nacos-logs:/home/nacos/logs
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8848/nacos/v1/console/health/readiness"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - microservices-network
    restart: unless-stopped

  sentinel:
    image: bladex/sentinel-dashboard:1.8.6
    container_name: sentinel
    environment:
      - JAVA_OPTS=-Dserver.port=8858 -Dcsp.sentinel.dashboard.server=localhost:8858
    ports:
      - "8858:8858"
    networks:
      - microservices-network
    restart: unless-stopped

  # ==================== Java 微服务（使用远程镜像）====================

  user-service:
    image: ${REGISTRY:-gzhidao1010}/user-service:${TAG:-latest}
    container_name: user-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=user_db
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD:-root123}
      - DOCKER_HOST_IP=user-service
      - JAVA_OPTS=-Xms256m -Xmx512m
    ports:
      - "8001:8001"
      - "20880:20880"
    depends_on:
      mysql:
        condition: service_healthy
      nacos:
        condition: service_healthy
    networks:
      - microservices-network
    restart: unless-stopped

  order-service:
    image: ${REGISTRY:-gzhidao1010}/order-service:${TAG:-latest}
    container_name: order-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=order_db
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD:-root123}
      - DOCKER_HOST_IP=order-service
      - JAVA_OPTS=-Xms256m -Xmx512m
    ports:
      - "8002:8002"
      - "20881:20881"
    depends_on:
      mysql:
        condition: service_healthy
      nacos:
        condition: service_healthy
      user-service:
        condition: service_started
    networks:
      - microservices-network
    restart: unless-stopped

  api-gateway:
    image: ${REGISTRY:-gzhidao1010}/api-gateway:${TAG:-latest}
    container_name: api-gateway
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - SENTINEL_DASHBOARD=sentinel:8858
      - JAVA_OPTS=-Xms256m -Xmx512m
    ports:
      - "8080:8080"
    depends_on:
      nacos:
        condition: service_healthy
      user-service:
        condition: service_started
      order-service:
        condition: service_started
    networks:
      - microservices-network
    restart: unless-stopped

networks:
  microservices-network:
    driver: bridge

volumes:
  mysql-data:
    driver: local
  nacos-data:
    driver: local
  nacos-logs:
    driver: local
