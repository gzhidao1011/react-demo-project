# GitHub 协作规范

本文档定义了项目中使用 GitHub 进行协作的规范，包括协作者管理、权限设置、PR 权限授予等。

> **重要**：所有 GitHub 协作操作必须遵循本文档规范，确保团队协作的规范性和安全性。

## 核心原则

1. **最小权限原则**：只授予必要的权限
2. **权限分级管理**：根据角色分配不同权限级别
3. **代码审查必需**：所有代码变更必须通过 PR 和审查
4. **文档记录**：记录权限分配的原因和变更

## 协作者管理

### 添加协作者

#### 方法 1：通过仓库设置添加（推荐）

**步骤**：

1. 进入仓库 **Settings** → **Collaborators**
2. 点击 **Add people** 按钮
3. 输入用户名（如 `dujiaoai`）
4. 选择权限级别（见下方权限级别说明）
5. 点击 **Add [username] to this repository**
6. 等待用户接受邀请

#### 方法 2：通过邀请链接添加

1. 进入 **Settings** → **Collaborators**
2. 点击 **Add people**
3. 复制邀请链接
4. 将链接发送给用户，让其访问并接受邀请

### 权限级别说明

| 权限级别 | 创建 PR | 审查 PR | 合并 PR | 直接推送 | 管理仓库 |
|---------|---------|---------|---------|---------|---------|
| **Read** | ✅ | ✅ | ❌ | ❌ | ❌ |
| **Triage** | ✅ | ✅ | ❌ | ❌ | ❌ |
| **Write** | ✅ | ✅ | ✅* | ✅ | ❌ |
| **Maintain** | ✅ | ✅ | ✅* | ✅ | ✅（部分） |
| **Admin** | ✅ | ✅ | ✅* | ✅ | ✅ |

*注意：如果分支有保护规则，仍然需要满足条件才能合并。

### 权限级别详细说明

#### 1. Read（读取）

**权限**：
- ✅ 查看仓库代码
- ✅ 克隆仓库
- ✅ 创建 Issue
- ✅ 创建 PR（但需要仓库所有者审批）

**限制**：
- ❌ 不能直接推送代码
- ❌ 不能合并 PR
- ❌ 不能修改仓库设置

**适用场景**：
- 只需要查看代码和创建 PR
- 外部贡献者

#### 2. Triage（分类）

**权限**：
- ✅ Read 的所有权限
- ✅ 管理 Issue 和 PR（标记、分配、关闭等）
- ✅ 编辑 Issue 和 PR 的标签

**限制**：
- ❌ 不能推送代码
- ❌ 不能合并 PR
- ❌ 不能修改仓库设置

**适用场景**：
- 需要管理 Issue 和 PR
- 项目维护助手

#### 3. Write（写入）⭐ 推荐

**权限**：
- ✅ Triage 的所有权限
- ✅ 推送代码到非保护分支
- ✅ 创建和删除分支
- ✅ 合并 PR（如果分支未受保护）

**限制**：
- ❌ 不能合并到受保护的分支（如 main）
- ❌ 不能修改仓库设置
- ❌ 不能删除仓库

**适用场景**：
- 团队成员
- 需要推送代码和合并 PR

#### 4. Maintain（维护）

**权限**：
- ✅ Write 的所有权限
- ✅ 管理仓库设置（部分）
- ✅ 管理 Actions、Packages 等

**限制**：
- ❌ 不能删除仓库
- ❌ 不能转移仓库所有权
- ❌ 不能管理协作者

**适用场景**：
- 项目维护者
- 需要管理仓库设置

#### 5. Admin（管理员）

**权限**：
- ✅ 所有权限
- ✅ 管理协作者
- ✅ 修改仓库设置
- ✅ 删除仓库（需要所有者确认）

**限制**：
- ❌ 不能转移仓库所有权
- ❌ 不能删除组织（如果是组织仓库）

**适用场景**：
- 仓库所有者
- 需要完全控制权限

## 授予合并 PR 权限

### 必需步骤

#### 步骤 1：授予 Write 权限（必需）

1. 进入仓库 **Settings** → **Collaborators**
2. 找到协作者（或添加新协作者）
3. 将权限设置为 **Write** 或更高
4. 保存更改

#### 步骤 2：检查分支保护规则

如果主分支有保护规则，协作者需要满足条件才能合并：
- ✅ 通过所有 CI 检查
- ✅ 获得审查者审批
- ✅ 解决所有评论
- ✅ 分支同步

### 分支保护规则的影响

#### 情况 1：主分支没有保护规则

**协作者权限**：**Write** 或更高

**可以**：
- ✅ 直接合并 PR（无需审批）
- ✅ 直接推送代码到主分支
- ✅ 创建和删除分支

**注意**：虽然可以直接合并，但建议：
- ✅ 仍然进行代码审查
- ✅ 确保 CI 检查通过
- ✅ 遵循团队工作流程

#### 情况 2：主分支有保护规则

**协作者权限**：**Write** 或更高

**仍然需要满足**：
- ✅ **通过所有 CI 检查**（必需）
- ✅ **获得审查者审批**（必需）
- ✅ **CODEOWNERS 审批**（如果配置了）
- ✅ **解决所有评论**（必需）
- ✅ **分支同步**（必需）

**即使有 Write 权限，也不能绕过保护规则！**

## CODEOWNERS 配置

### 更新 CODEOWNERS 文件

编辑 `.github/CODEOWNERS`：

```codeowners
# 全局默认审查者
* @gzhidao1011 @dujiaoai

# 特定路径的审查者
apps/web/ @gzhidao1011 @dujiaoai
packages/utils/ @gzhidao1011 @dujiaoai
```

### CODEOWNERS 的作用

- ✅ 自动分配审查者
- ✅ 如果配置了分支保护规则，CODEOWNERS 指定的审查者必须审批
- ❌ **不影响合并权限**（权限级别决定）

## 个人账户私有仓库限制

### 重要说明

**如果您的仓库是个人账户下的私有仓库**，GitHub 的分支保护规则功能**不会生效**。

GitHub 的分支保护规则仅在以下情况下可用：
- ✅ **公开仓库**（Public）：个人账户和组织账户都支持
- ✅ **GitHub Team 或 Enterprise 账户的私有仓库**：需要付费订阅

### 个人账户私有仓库的替代方案

虽然无法使用 GitHub 的分支保护规则，但您仍然可以通过以下方式确保代码质量：

#### 1. 使用 CI/CD 检查（已配置）✅

项目已配置了 `.github/workflows/test.yml`，会在 PR 时自动运行：
- 类型检查
- 代码检查（lint、format）
- 测试执行
- 覆盖率报告

**手动检查清单**：
- 在合并 PR 前，确保所有 CI 检查通过（显示 ✅）
- 查看工作流日志，确认没有错误

#### 2. CODEOWNERS 审查（已配置）✅

项目已配置了 `.github/CODEOWNERS`，会自动分配审查者。

**手动检查清单**：
- 确保 CODEOWNERS 指定的审查者已审批 PR
- 解决所有 PR 评论

#### 3. PR 模板规范（已配置）✅

项目已配置了 PR 模板，规范 PR 描述格式。

**手动检查清单**：
- 确保 PR 描述完整
- 勾选所有适用的变更类型
- 提供测试步骤和截图（如适用）

#### 4. 团队协作约定

建立团队协作约定：
- **必须通过 CI 检查才能合并**：所有 CI 检查必须显示 ✅
- **必须获得审查者审批**：至少 1 个审查者审批
- **必须解决所有评论**：所有 PR 评论必须解决
- **必须保持分支最新**：合并前 rebase 或 merge upstream

## 故障排除

### 问题 1：GitHub 页面没有显示权限下拉菜单

**可能原因**：

1. **个人账户私有仓库的限制**：
   - 个人账户的私有仓库对协作者权限管理有限
   - 默认权限通常是 Read，且可能无法修改
   - **解决方案**：移除后重新添加，或升级到组织账户

2. **界面位置不同**：
   - 权限设置可能在添加时显示，而不是在列表中
   - **解决方案**：在添加协作者时查找权限选择

3. **浏览器缓存问题**：
   - **解决方案**：清除浏览器缓存或使用无痕模式

### 问题 2：协作者无法合并 PR

**可能原因**：
1. 权限级别不够（需要 Write 或更高）
2. 分支有保护规则，未满足条件
3. PR 未通过 CI 检查
4. 未获得审查者审批

**解决方案**：
1. 检查权限级别
2. 检查分支保护规则
3. 确保所有 CI 检查通过
4. 确保获得审查者审批

### 问题 3：如何确认当前权限

**方法 1**：在协作者列表中查看
- 进入 **Settings** → **Collaborators**
- 查看协作者列表中的权限显示

**方法 2**：查看协作者详情
- 点击协作者名称
- 查看详细信息页面

**方法 3**：让协作者自己查看
- 打开仓库页面
- 点击右上角的 **Settings**（个人设置）
- 查看 **Access** 部分

## 推荐权限配置

### 小型团队（2-5 人）

**推荐配置**：
- 所有成员：**Write** 权限
- 主分支：配置保护规则（如果支持）
- CODEOWNERS：所有成员

### 中型团队（5-20 人）

**推荐配置**：
- 核心成员：**Write** 权限
- 新成员：**Read** 权限（通过 PR 贡献）
- 主分支：严格保护规则（如果支持）
- CODEOWNERS：核心成员

### 大型团队（20+ 人）

**推荐配置**：
- 维护者：**Maintain** 权限
- 核心贡献者：**Write** 权限
- 贡献者：**Read** 权限
- 主分支：严格保护规则（如果支持）
- CODEOWNERS：维护者和核心贡献者

## 最佳实践

### 权限管理

1. ✅ **最小权限原则**：只授予必要的权限
2. ✅ **定期审查**：定期检查协作者列表和权限
3. ✅ **使用 CODEOWNERS**：自动分配审查者
4. ✅ **文档记录**：记录权限分配的原因

### 团队协作

1. ✅ **明确角色**：明确每个成员的职责和权限
2. ✅ **统一流程**：使用 PR 流程进行代码审查
3. ✅ **及时响应**：及时处理 PR 和审查请求

## 相关文档

### 相关规范文档

- [PR 工作流程规范](./17-PR工作流程规范.mdc) - PR 创建、审查、合并流程
- [分支保护规范](./18-分支保护规范.mdc) - 分支保护规则配置

### 外部文档

- [CODEOWNERS 配置](../.github/CODEOWNERS) - CODEOWNERS 文件配置

## 常见问题

### Q: 如何查看用户的当前权限？

**A**: 
1. 进入 **Settings** → **Collaborators**
2. 在用户列表中查看权限级别

### Q: 如何修改用户的权限？

**A**: 
1. 进入 **Settings** → **Collaborators**
2. 找到用户，点击权限下拉菜单
3. 选择新的权限级别

### Q: 个人账户私有仓库可以配置分支保护规则吗？

**A**: 
- ❌ 不可以，这是 GitHub 的限制
- ✅ 可以使用 CI/CD 检查、CODEOWNERS 等替代方案
- ✅ 升级到 GitHub Team 或组织账户可以使用完整功能

### Q: Write 权限可以合并所有分支的 PR 吗？

**A**: 
- ✅ 可以合并非保护分支的 PR
- ✅ 可以合并保护分支的 PR（如果满足保护规则）
- ❌ 不能绕过分支保护规则
