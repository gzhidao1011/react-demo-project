# PR 工作流程规范

本文档定义了项目中使用 Pull Request（PR）进行代码协作的完整工作流程，包括 PR 创建、审查、合并等各个环节的规范。

> **重要**：所有代码变更必须通过 PR 流程，禁止直接推送到主分支。

## 核心原则

1. **所有变更通过 PR**：禁止直接推送到主分支
2. **代码审查必需**：所有 PR 必须经过审查
3. **CI 检查通过**：所有 CI 检查必须通过才能合并
4. **分支同步**：合并前确保分支与主分支同步
5. **描述完整**：PR 描述必须清晰完整

## PR 创建流程

### 步骤 1：创建功能分支

```bash
# 从主分支创建新分支
git checkout main
git pull origin main
git checkout -b feature/your-feature-name

# 或修复 bug
git checkout -b fix/bug-description
```

### 步骤 2：进行代码变更

- 编写代码
- 运行本地检查：`pnpm check`
- 运行测试：`pnpm test`
- 确保代码符合项目规范

### 步骤 3：提交代码

```bash
# 查看变更
git status

# 添加变更的文件
git add .

# 提交（遵循 Conventional Commits 规范）
git commit -m "feat: 添加新功能"

# 推送到远程仓库
git push origin feature/your-feature-name
```

### 步骤 4：创建 PR

1. 在 GitHub 上创建 PR
2. PR 模板会自动填充
3. 填写变更描述和相关信息：
   - **标题**：清晰描述变更内容
   - **描述**：详细说明变更目的、影响范围
   - **变更类型**：勾选适用的类型
   - **测试步骤**：提供测试方法（如适用）

## PR 审查流程

### 自动分配审查者

项目配置了 `.github/CODEOWNERS`，会自动根据文件路径分配审查者：

```codeowners
# 全局默认审查者
* @gzhidao1011 @dujiaoai

# 特定路径
apps/web/ @gzhidao1011 @dujiaoai
packages/utils/ @gzhidao1011 @dujiaoai
```

### 审查者职责

1. ✅ **及时审查 PR**：收到通知后及时审查
2. ✅ **提供建设性反馈**：指出问题并提供改进建议
3. ✅ **关注代码质量**：检查代码风格、逻辑、可维护性
4. ✅ **确保测试覆盖**：确保新功能有测试覆盖
5. ✅ **及时审批**：满足条件时及时审批

### PR 作者职责

1. ✅ **响应审查反馈**：及时回复和修改
2. ✅ **解决所有评论**：确保所有评论都已解决
3. ✅ **保持分支同步**：定期同步主分支最新代码
4. ✅ **修复 CI 失败**：确保所有 CI 检查通过

## PR 合并前检查清单

在合并 PR 之前，**必须**确保完成以下检查：

### ✅ 1. CI/CD 检查通过

**检查位置**：PR 页面底部的 **Checks** 部分

**必须满足**：
- [ ] `Test / test` 工作流显示 ✅（绿色）
- [ ] 所有步骤都成功：
  - [ ] 类型检查通过
  - [ ] 代码检查（lint、format）通过
  - [ ] 测试通过
  - [ ] 覆盖率报告生成成功

**如果失败**：
- ❌ **禁止合并**，必须先修复问题
- 查看工作流日志，找到失败原因
- 修复问题后推送新提交
- 等待 CI 重新运行并通过

### ✅ 2. 代码审查

**检查位置**：PR 页面右侧的 **Reviewers** 部分

**必须满足**：
- [ ] CODEOWNERS 指定的审查者已审批（显示 ✅）
- [ ] 至少 1 个审查者审批（如果配置了 CODEOWNERS）
- [ ] 所有审查评论已解决

**如果未审批**：
- ❌ **禁止合并**，必须等待审查者审批
- 如果审查者提出修改建议，需要先修改代码

### ✅ 3. PR 描述完整

**检查位置**：PR 页面顶部的描述部分

**建议满足**：
- [ ] PR 描述清晰说明变更目的
- [ ] 已勾选变更类型
- [ ] 已说明影响范围
- [ ] 已提供测试步骤（如适用）

### ✅ 4. 分支同步

**检查位置**：PR 页面顶部的分支状态

**必须满足**：
- [ ] 分支与主分支同步（显示 "This branch is up to date"）
- [ ] 或已解决合并冲突

**如果不同步**：
- ❌ **禁止合并**，必须先同步分支
- 参考下面的"同步分支"部分

## 同步分支

如果 PR 分支与主分支不同步，需要先同步：

### 方法 1：在 GitHub 上更新分支（推荐）

1. 在 PR 页面点击 **Update branch** 按钮
2. GitHub 会自动合并主分支的最新更改
3. 如果有冲突，需要解决冲突后推送

### 方法 2：使用命令行同步

```bash
# 切换到 PR 分支
git checkout your-branch-name

# 方法 A：Rebase（推荐，保持历史整洁）
git fetch origin
git rebase origin/main
# 如果有冲突，解决冲突后：
git add .
git rebase --continue
git push --force-with-lease

# 方法 B：Merge（保留合并历史）
git fetch origin
git merge origin/main
# 如果有冲突，解决冲突后：
git add .
git commit -m "chore: merge main into branch"
git push
```

## PR 合并方式

### 方式 1：Squash and merge（推荐）⭐

**适用场景**：
- PR 包含多个提交，但希望合并为一个提交
- 保持主分支历史整洁
- **大多数情况推荐使用**

**效果**：
- 将 PR 的所有提交合并为一个提交
- 提交信息使用 PR 的标题和描述
- 主分支历史更清晰

**操作**：
1. 点击 **Squash and merge**
2. 可以编辑提交信息（默认使用 PR 标题和描述）
3. 点击 **Confirm squash and merge**

### 方式 2：Create a merge commit

**适用场景**：
- 需要保留 PR 的完整提交历史
- 希望看到 PR 中的所有提交记录

**效果**：
- 保留 PR 中的所有提交
- 创建一个合并提交（merge commit）
- 主分支历史包含所有提交记录

**操作**：
1. 点击 **Create a merge commit**
2. 点击 **Confirm merge**

### 方式 3：Rebase and merge

**适用场景**：
- 希望将 PR 的提交直接应用到主分支
- 不使用合并提交，保持线性历史

**效果**：
- 将 PR 的提交 rebase 到主分支
- 不创建合并提交
- 主分支历史是线性的

**操作**：
1. 点击 **Rebase and merge**
2. 点击 **Confirm rebase and merge**

**注意**：如果 PR 分支有多个提交，rebase 可能会重写提交历史。

### 合并方式对比

| 特性 | Create a merge commit | Squash and merge | Rebase and merge |
|------|----------------------|------------------|------------------|
| **保留提交历史** | ✅ 完整保留 | ❌ 压缩为一个 | ✅ 保留但重写 |
| **合并提交** | ✅ 创建 | ❌ 不创建 | ❌ 不创建 |
| **主分支历史** | 分支结构 | 线性 | 线性 |
| **提交 SHA** | 不变 | 新 SHA | 新 SHA |
| **历史清晰度** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **适用场景** | 需要详细历史 | 大多数情况 | 需要线性历史 |
| **推荐度** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |

## PR 预览

### 方法 1：在 GitHub 上查看代码差异（最简单）

1. 打开 PR 页面
2. 点击 **Files changed** 标签
3. 浏览所有更改的文件
4. 点击文件名查看详细差异

### 方法 2：在本地 checkout PR 分支（推荐）

```bash
# 方法 A：使用 GitHub CLI（如果已安装）
gh pr checkout <PR_NUMBER>

# 方法 B：手动 checkout
git fetch origin
git checkout feature/your-feature-name

# 运行和测试
pnpm install
pnpm check
pnpm test
pnpm dev  # 如果是前端应用
```

### 方法 3：部署预览（推荐用于前端应用）

配置 Vercel 或 Netlify 后：
- ✅ 每次创建 PR，自动部署预览
- ✅ PR 评论中自动显示预览链接
- ✅ 每次推送新提交，预览自动更新

**详细配置**：请参考 [部署预览规范](./19-部署预览规范.mdc)

## 解决合并冲突

如果 PR 与主分支有冲突：

### 方法 1：在 GitHub 上解决（简单冲突）

1. 在 PR 页面点击 **Resolve conflicts**
2. GitHub 会显示冲突文件
3. 编辑文件，解决冲突（删除冲突标记，保留正确的代码）
4. 点击 **Mark as resolved**
5. 点击 **Commit merge**

### 方法 2：在本地解决（复杂冲突）

```bash
# 1. 切换到 PR 分支
git checkout your-branch-name

# 2. 拉取主分支最新代码
git fetch origin
git merge origin/main

# 3. 解决冲突
# 编辑冲突文件，解决冲突

# 4. 提交解决后的代码
git add .
git commit -m "chore: resolve merge conflicts"

# 5. 推送到远程
git push
```

## 禁止的操作

以下情况**禁止**合并 PR：

- ❌ **CI 检查失败**：必须先修复问题
- ❌ **未获得审查者审批**：必须等待审批
- ❌ **有未解决的评论**：必须先解决所有评论
- ❌ **分支未同步**：必须先同步分支
- ❌ **有合并冲突**：必须先解决冲突
- ❌ **PR 标记为 Draft**：必须先标记为 Ready for review
- ❌ **直接推送到主分支**：必须通过 PR

## PR 集成功能

### 已集成的功能

1. **PR 模板**：`.github/PULL_REQUEST_TEMPLATE.md`
   - 创建 PR 时自动填充模板
   - 规范 PR 描述格式

2. **CODEOWNERS**：`.github/CODEOWNERS`
   - 自动分配代码审查者
   - 根据文件路径匹配审查者

3. **CI/CD 工作流**：`.github/workflows/test.yml`
   - PR 触发自动测试
   - 类型检查、代码检查、测试执行
   - 覆盖率报告生成和上传

4. **Codecov 覆盖率集成**（如果已配置）
   - 在 PR 中显示代码覆盖率
   - 显示覆盖率变化
   - 覆盖率评论和徽章

## 最佳实践

### PR 描述

- ✅ 清晰描述变更目的和内容
- ✅ 关联相关 Issue
- ✅ 提供测试步骤和截图（如适用）
- ✅ 勾选所有适用的变更类型

### 代码审查

- ✅ 及时响应审查请求
- ✅ 提供建设性反馈
- ✅ 关注代码质量和可维护性
- ✅ 确保测试覆盖新功能

### CI/CD

- ✅ 确保所有 CI 检查通过
- ✅ 关注覆盖率变化
- ✅ 修复失败的测试和检查
- ✅ 保持代码库健康

### 合并

- ✅ 使用 Squash and merge（推荐）
- ✅ 编辑提交信息确保清晰
- ✅ 删除已合并的分支
- ✅ 验证合并结果

## 相关文档

### 相关规范文档

- [GitHub 协作规范](./16-GitHub协作规范.mdc) - 协作者管理和权限
- [分支保护规范](./18-分支保护规范.mdc) - 分支保护规则配置
- [部署预览规范](./19-部署预览规范.mdc) - PR 预览和开发环境的部署方案
- [测试与覆盖率规范](./20-测试与覆盖率规范.mdc) - 测试编写规范和覆盖率要求

## 常见问题

### Q: 合并后可以撤销吗？

**A**: 可以，但需要谨慎操作：
- 如果刚合并，可以使用 `git revert` 创建一个撤销提交
- 如果已经推送，需要创建新的 PR 来修复

### Q: 合并后 PR 会自动关闭吗？

**A**: 是的，合并后 PR 会自动关闭。

### Q: 可以重新打开已合并的 PR 吗？

**A**: 不可以，但可以创建新的 PR 来修复问题。

### Q: 哪种合并方式最常用？

**A**: **Squash and merge** 是最常用的方式，因为它能保持主分支历史整洁。

### Q: 必须预览才能合并吗？

**A**: 
- 强烈建议预览后再合并
- 特别是对于重要更改
- 可以避免引入问题
