---
description:
globs:
alwaysApply: true
---

# API 结构

本文档定义了前端项目的 API 请求结构和规范，确保 API 调用的统一性和可维护性。

> **重要**：所有 API 请求必须使用 `@repo/services` 包，禁止直接使用 axios。

## 核心请求库

### @repo/services 包

项目使用 `@repo/services` 包统一封装所有 HTTP 请求，提供以下功能：

- ✅ 统一的请求拦截器（自动注入 token）
- ✅ 统一的响应拦截器（错误处理、token 刷新）
- ✅ 类型安全的 API 调用
- ✅ 可配置的错误处理
- ✅ 基于 `APIServiceBase` 类的服务模式

**包位置**：`packages/services/`

## 目录结构

```
packages/services/src/
├── index.ts                    # 主入口，导出所有 API 服务
├── api.service.ts              # API 服务实例
├── api.service.base.ts         # APIServiceBase 基类（核心请求封装）
├── auth.service.ts             # 认证相关 API
├── chat.service.ts             # 聊天相关 API
├── locale.service.ts           # 本地化相关 API
├── user-management.service.ts  # 用户管理相关 API
└── user-management.types.ts   # 用户管理类型定义
```

## API 模块说明

### 核心模块

| 模块         | 文件                          | 说明                           |
| ------------ | ----------------------------- | ------------------------------ |
| **认证**     | `auth.service.ts`             | 用户认证、登录、注册、token 刷新 |
| **聊天**     | `chat.service.ts`             | 聊天会话、消息管理             |
| **本地化**   | `locale.service.ts`           | 用户语言偏好设置               |
| **用户管理** | `user-management.service.ts`  | 用户、角色、权限管理           |

### 核心类和方法

- **`APIServiceBase`**：抽象基类，提供统一的 HTTP 请求封装
- **`apiService`**：全局 API 服务实例，可直接使用
- **`handleApiResponse`**：统一处理 API 响应，检查业务 code 并抛出错误

## 使用方法

### 1. 使用 apiService 实例（推荐）

```typescript
import { apiService } from "@repo/services"
import type { ApiResponseBase } from "@repo/services"

// GET 请求
const response = await apiService.get<ApiResponseBase<User>>("/users/123")
if (response.data.code !== 0 && response.data.code !== 200) {
  throw new Error(response.data.message || "获取用户失败")
}
const user = response.data.data!

// POST 请求
const createResponse = await apiService.post<ApiResponseBase<User>>("/users", {
  username: "test",
  email: "test@example.com",
})
if (createResponse.data.code !== 0 && createResponse.data.code !== 200) {
  throw new Error(createResponse.data.message || "创建用户失败")
}
const newUser = createResponse.data.data!

// PUT 请求
await apiService.put<ApiResponseBase<void>>("/users/123", {
  nickname: "新昵称",
})

// DELETE 请求
await apiService.delete<ApiResponseBase<void>>("/users/123")

// PATCH 请求
await apiService.patch<ApiResponseBase<void>>("/users/123", {
  status: "active",
})
```

### 2. 使用预定义的 API 服务函数

```typescript
import { authLogin, authRegister, getUserById } from "@repo/services"
import type { LoginRequest, RegisterRequest, UserDetailDto } from "@repo/services"

// 登录
const loginResponse = await authLogin({
  email: "user@example.com",
  password: "password123",
})

// 注册
const registerResponse = await authRegister({
  email: "user@example.com",
  password: "password123",
})

// 获取用户详情
const user = await getUserById("123")
```

### 3. 使用 handleApiResponse 统一处理响应

```typescript
import { apiService, handleApiResponse } from "@repo/services"
import type { ApiResponseBase } from "@repo/services"

// 使用 handleApiResponse 自动检查业务错误
const response = await apiService.get<ApiResponseBase<User>>("/users/123")
const user = handleApiResponse(response, "获取用户失败").data!
```

### 4. 在 React 组件中使用

```tsx
import { useState, useEffect } from "react"
import { getUserById } from "@repo/services"
import type { UserDetailDto } from "@repo/services"

export function UserProfile({ userId }: { userId: string }) {
  const [user, setUser] = useState<UserDetailDto | null>(null)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    const fetchUser = async () => {
      try {
        setLoading(true)
        const userData = await getUserById(userId)
        setUser(userData)
      } catch (err) {
        setError(err instanceof Error ? err.message : "获取用户失败")
      } finally {
        setLoading(false)
      }
    }

    fetchUser()
  }, [userId])

  if (loading) return <div>加载中...</div>
  if (error) return <div>错误: {error}</div>
  if (!user) return null

  return <div>{user.username}</div>
}
```

## 请求流程

```
组件/Feature
  ↓
@repo/services (APIServiceBase 封装 axios)
  ↓
请求拦截器
  ├─ 添加 Token（Authorization: Bearer <token>）
  └─ 添加自定义 Headers
  ↓
后端 API
  ↓
响应拦截器
  ├─ 业务错误处理（code !== 0/200）
  ├─ Token 过期处理（自动刷新 Token → 重试请求）
  ├─ 未授权处理（code === 401）
  │   └─ 清除 token 并跳转登录页
  └─ 返回响应数据
```

## 类型定义

### 响应数据结构

```typescript
interface ApiResponseBase<T> {
  code: number;        // 0 或 200 表示成功
  message: string;     // 错误消息
  data: T | null;      // 响应数据
  timestamp?: number; // 时间戳
  traceId?: string;    // 追踪 ID
  errors?: Array<{     // 字段级错误数组
    field: string;
    message: string;
    code?: string;
  }>;
}
```

### 请求配置

`APIServiceBase` 使用标准的 `AxiosRequestConfig`，支持所有 axios 配置选项：

```typescript
// 自定义 headers
await apiService.get("/api/data", {}, {
  headers: {
    "Custom-Header": "value",
  },
})

// 设置超时
await apiService.get("/api/data", {}, {
  timeout: 5000,
})
```

### 类型定义组织

- 每个服务文件包含相关的类型定义（如 `auth.service.ts` 包含认证相关类型）
- 类型通过 `index.ts` 统一导出
- 使用 TypeScript 类型确保类型安全

## 错误处理

### 自动错误处理

- **业务错误**（`code !== 0 && code !== 200`）：自动显示错误提示
- **Token 过期**（`code === 99999`）：自动刷新 token 并重试请求
- **未授权**（`code === 401`）：自动清除用户信息并跳转登录页

### 自定义错误处理

```typescript
import { apiService } from "@repo/services"
import type { ApiResponseBase } from "@repo/services"

try {
  const response = await apiService.get<ApiResponseBase<User>>("/users/123")
  
  // 检查业务错误
  if (response.data.code !== 0 && response.data.code !== 200) {
    // 处理字段级错误
    if (response.data.errors && response.data.errors.length > 0) {
      const fieldErrors = response.data.errors
      // 处理字段级错误...
    }
    
    // 处理通用错误
    throw new Error(response.data.message || "操作失败")
  }
  
  const user = response.data.data!
} catch (error) {
  // 自定义错误处理逻辑
  if (error instanceof Error) {
    console.error("API 错误:", error.message)
    // 处理特定错误...
  }
}
```

## 最佳实践

### 1. 必须使用 @repo/services

```typescript
// ✅ 正确：使用 @repo/services
import { apiService } from "@repo/services"
import { authLogin } from "@repo/services"

// ❌ 错误：直接使用 axios
import axios from "axios"
```

### 2. 使用类型定义

```typescript
// ✅ 正确：使用类型定义
import { getUserById } from "@repo/services"
import type { UserDetailDto } from "@repo/services"

const user = await getUserById("123")

// ❌ 错误：不使用类型
const user = await getUserById("123") // 缺少类型检查
```

### 3. 错误处理

```typescript
// ✅ 正确：包含错误处理
try {
  const user = await getUserById("123")
} catch (error) {
  console.error("获取用户失败:", error)
  // 显示用户友好的错误提示
}

// ❌ 错误：没有错误处理
const user = await getUserById("123") // 可能抛出未捕获的错误
```

### 4. 在 React Hooks 中封装

```typescript
// ✅ 推荐：在自定义 Hook 中封装 API 调用
import { useState, useEffect } from "react"
import { getUserById } from "@repo/services"
import type { UserDetailDto } from "@repo/services"

export function useUser(userId: string) {
  const [user, setUser] = useState<UserDetailDto | null>(null)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<Error | null>(null)

  useEffect(() => {
    const fetchUser = async () => {
      try {
        setLoading(true)
        const userData = await getUserById(userId)
        setUser(userData)
      } catch (err) {
        setError(err instanceof Error ? err : new Error("获取用户失败"))
      } finally {
        setLoading(false)
      }
    }

    fetchUser()
  }, [userId])

  return { user, loading, error }
}
```

### 5. API 服务组织

- **按功能划分服务**：每个业务功能对应一个服务文件（如 `auth.service.ts`）
- **类型与服务对应**：类型定义放在对应的服务文件中或独立的类型文件
- **统一导出**：通过 `index.ts` 统一导出所有服务和类型
- **使用 APIServiceBase**：继承 `APIServiceBase` 创建自定义服务类

## 注意事项

1. **禁止直接使用 axios**：所有请求必须通过 `@repo/services` 包
2. **使用类型定义**：充分利用 TypeScript 类型，提高代码安全性
3. **错误处理**：所有异步操作必须包含错误处理，使用 `handleApiResponse` 或手动检查 `code` 字段
4. **Token 管理**：token 的注入和刷新由 `APIServiceBase` 自动处理，无需手动管理
5. **BaseURL 配置**：baseURL 根据环境变量 `VITE_API_BASE_URL` 自动配置，开发环境默认使用相对路径 `/api`
6. **业务错误检查**：必须检查 `response.data.code`，只有 `code === 0` 或 `code === 200` 才表示成功

## 相关文档

### 相关规范文档

- [表单错误处理规范](./10-表单错误处理.mdc) - 表单错误处理和 API 错误处理
- [代码风格](./01-代码风格.mdc) - TypeScript/JavaScript 代码风格
- [安全规范](./21-安全规范.mdc) - API 安全最佳实践
