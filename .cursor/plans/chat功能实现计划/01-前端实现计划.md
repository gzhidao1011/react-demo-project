---
name: Chat 前端实现计划
overview: 基于 Vercel AI SDK 的 Chat 前端实现计划，涵盖 useChat、流式 UI、会话管理、主流 UX 模式及与后端接口契约。
todos: []
isProject: false
---

# Chat 前端实现计划

## 文档结构

本计划为 Chat 功能的前端部分，后端实现见 [02-后端实现计划.md](./02-后端实现计划.md)。

| 文档 | 说明 |
|------|------|
| **01-前端实现计划.md**（本文档） | 前端实现：useChat、组件、UX、接口对接 |
| [02-后端实现计划.md](./02-后端实现计划.md) | 后端实现：chat-service、SSE 协议、LLM 对接 |
| [vercel-ai-sdk-guide.md](./vercel-ai-sdk-guide.md) | Vercel AI SDK 使用指南 |

---

## 〇、国外主流 AI Chat 趋势（2024–2025）

### 0.1 主流产品与设计基准

| 产品 | 特点 | 设计亮点 |
|------|------|----------|
| **ChatGPT** (OpenAI) | 行业标杆 | 极简设计、无干扰聊天窗口、可折叠侧边栏、会话重命名 |
| **Claude** (Anthropic) | 长上下文 | 清晰气泡、附件支持、Thinking 模式 |
| **Gemini** (Google) | 多模态 | 图片输入、结构化输出、Sources 引用 |
| **Poe** | 多模型聚合 | 模型切换、快捷提示词 |
| **Perplexity** | 搜索增强 | Sources 引用、联网搜索 |

**设计原则**（参考 OpenAI Apps SDK 指南）：

- **Know**：提供用户无法直接获取的新上下文或数据
- **Do**：代表用户执行真实操作
- **Show**：以比纯文本更清晰、可操作的 UI 呈现信息

### 0.2 UI/UX 主流趋势

- **极简聊天窗口**：无干扰、专注对话
- **可折叠侧边栏**：会话列表、新建对话、模型选择
- **会话重命名**：便于组织 prompt 历史
- **模型选择**：Auto / Fast / Thinking 等模式（ChatGPT 2025 更新）
- **欢迎/空状态**：引导新建对话、提供快捷提示词（Suggested Prompts）
- **消息操作**：复制、删除、重新生成、编辑（可选）
- **消息反馈**：👍/👎 对 AI 回复质量反馈（ChatGPT、Meta AI 标配）

### 0.3 功能分层建议

| 层级 | 功能 | 优先级 |
|------|------|--------|
| **P0 核心** | 流式对话、会话列表、新建/切换/删除、Stop/Regenerate | 必须 |
| **P1 增强** | Markdown 渲染、附件（图片）、会话重命名、错误重试、欢迎空状态 + 快捷提示词 | 推荐 |
| **P2 进阶** | 模型选择、Token 用量、Sources 引用、Reasoning 展示、消息反馈（👍/👎）、免责声明 | 可选 |

### 0.4 UX 设计原则（主流心理学基础）

参考 ChatGPT、Claude、Perplexity 等产品的设计研究：

- **认知负荷理论**：极简界面、留白、中性色（白/灰/暗色模式），减少用户 overwhelm
- **Jakob 定律**：用户期望新产品行为与熟悉产品一致，保持统一的聊天界面（输入框、可折叠历史栏）
- **Hick 定律**：限制选择数量，使用预设操作按钮（如「总结」「改写」「扩展」）和极简引导，降低决策疲劳

### 0.5 信任与预期管理（Expectation Management）

主流产品通过明确告知 AI 能力边界来建立信任：

- **ChatGPT**：展示「ChatGPT can make mistakes. Check important info.」
- **Perplexity**：提供来源链接，便于用户评估信息可靠性
- **Claude**：使用审慎语气，明确说明不确定之处

**实现建议**：在聊天区域底部或首条 AI 消息前展示简短免责声明（如「AI 可能出错，请核实重要信息」），可选配置。

### 0.6 优雅降级（Failing Gracefully）

当 AI 无法理解或无法回答时，应引导用户而非直接终止：

- **ChatGPT**：提示用户换一种说法
- **Perplexity**：展示来源的同时，提供相关跟进建议
- **Meta AI**：以相同语气承认困惑，鼓励继续对话

**实现建议**：前端错误态展示「重试」或「换个说法」按钮。

---

## 一、技术选型

| 层级 | 技术 | 说明 |
|------|------|------|
| **前端** | React + Vercel AI SDK (`ai`, `@ai-sdk/react`) | `useChat` + `DefaultChatTransport`，流式 UI |
| **前端框架** | React Router | 已有 `(chat)` 路由组 |
| **认证** | JWT（已有 `@repo/services` + `@repo/utils`） | Chat API 需携带 Token |

---

## 二、实现要点

### 2.1 依赖安装

```bash
pnpm add ai @ai-sdk/react
```

可选（按需）：`@ai-sdk/openai`、`@ai-sdk/anthropic`（若前端直连，通常由后端统一调用）。

### 2.2 目录与文件结构

```
apps/web/app/(chat)/
├── page.tsx                    # 主页面（侧边栏 + 主区域）
├── layout.tsx                  # 已有
├── components/
│   ├── chat-sidebar.tsx       # 侧边栏：新建对话、会话列表
│   ├── chat-message-list.tsx   # 消息列表（message.parts 渲染）
│   ├── chat-message.tsx        # 单条消息（用户/AI，支持 Markdown、👍/👎 反馈）
│   ├── chat-input.tsx          # 输入框 + 发送按钮（Enter 发送、Shift+Enter 换行）
│   ├── chat-welcome.tsx        # 欢迎空状态 + 快捷提示词（Suggested Prompts）
│   └── index.ts
├── hooks/
│   ├── use-chat.ts             # 封装 useChat + 会话 ID
│   └── use-conversations.ts    # 会话列表、新建、切换、持久化
└── lib/
    └── chat.types.ts           # 类型定义（与后端契约对齐）
```

### 2.3 useChat 配置（核心）

参考 [vercel-ai-sdk-guide.md](./vercel-ai-sdk-guide.md)：

```tsx
// useChat 配置要点（主流产品标配：stop、regenerate、error 处理）
const { messages, sendMessage, status, error, stop, regenerate, clearError } = useChat({
  id: conversationId ?? undefined,
  messages: initialMessages,
  transport: new DefaultChatTransport({
    api: "/api/chat",
    headers: () => ({
      Authorization: `Bearer ${getAccessToken()}`,
    }),
    body: () => ({
      conversationId: conversationId ?? undefined,
    }),
    credentials: "include",
  }),
})
```

- `api`：通过 Vite 代理到 `http://localhost:8080/api/chat`
- `headers`：注入 JWT，后端校验
- `body`：可选传 `conversationId`，用于会话持久化
- **错误处理**：向用户展示通用文案（如 "Something went wrong."），避免泄露服务端细节；提供「重试」或「换个说法」按钮，符合优雅降级模式

**status 状态**：

| 值 | 含义 |
|----|------|
| `submitted` | 请求已发送，等待流开始 |
| `streaming` | 正在接收流式响应 |
| `ready` | 响应完成，可发送新消息 |
| `error` | 发生错误 |

### 2.4 消息渲染

- 使用 `message.parts` 而非 `message.content`（AI SDK 5.0+）
- `part.type === "text"` 时渲染文本，支持 `react-markdown` 做 Markdown 展示
- 用户消息：右对齐、主色背景；AI 消息：左对齐、muted 背景

**键盘快捷键**（主流产品标配）：

- `Enter`：发送消息
- `Shift+Enter`：换行（ChatGPT、Claude 等通用约定）
- 输入框 `disabled` 时（`status !== "ready"`）不响应发送快捷键

### 2.5 会话持久化（前端）

- `use-conversations.ts`：`conversations`、`activeId`、`createConversation`、`deleteConversation`
- 可选：`localStorage` 存会话列表；完整消息由后端持久化

**React Router 路由约定**：

- `/chat`：新建对话，`conversationId` 为 `null`
- `/chat/:id`：已有会话，`conversationId` 为 `:id`，需从后端或本地加载 `initialMessages`

**会话标题自动生成**（ChatGPT 模式）：

- 首条用户消息发送后，后端根据首条消息内容生成会话标题
- 前端在 `onFinish` 中接收 `conversationTitle` 并更新侧边栏，或通过单独接口获取

**持久化场景：仅发送最后一条消息**（后端从存储加载历史时）：

```tsx
transport: new DefaultChatTransport({
  api: "/api/chat",
  prepareSendMessagesRequest: ({ id, messages }) => ({
    body: {
      message: messages[messages.length - 1],
      id,
    },
  }),
})
```

服务端需从存储加载历史消息并拼接新消息。

### 2.6 Vercel AI SDK 6.x 高级特性（主流趋势）

| 特性 | 说明 | 实现建议 |
|------|------|----------|
| **Resume Streams** | 连接中断后恢复流式响应 | 后端支持 `Last-Event-ID`，前端 `useChat` 自动处理 |
| **experimental_throttle** | 节流 UI 更新，减少渲染 | `useChat({ experimental_throttle: 50 })` |
| **Message Metadata** | Token 用量、模型信息 | 后端 `messageMetadata` 返回，前端 `message.metadata` 展示 |
| **Reasoning** | 思维链展示（DeepSeek R1、Claude Thinking） | 后端 `sendReasoning: true`，前端渲染 `part.type === "reasoning"` |
| **Sources** | 引用来源（Perplexity、Google） | 后端 `sendSources: true`，前端渲染 `source-url` / `source-document` |
| **Attachments** | 图片、文件上传 | `sendMessage({ text, files })`，渲染 `part.type === "file"` |
| **Event Callbacks** | `onFinish`、`onError`、`onData` | 用于日志、埋点、自定义 UI 更新 |
| **消息反馈（👍/👎）** | 用户对 AI 回复的质量反馈 | 每条 AI 消息底部展示 👍/👎，点击后可选上报或展开反馈表单 |

**Reasoning 渲染示例**（主流产品如 ChatGPT o1、Claude Thinking）：

```tsx
{message.parts.map((part, index) => {
  if (part.type === "text") return <div key={index}>{part.text}</div>
  if (part.type === "reasoning")
    return (
      <details key={index} className="text-muted-foreground">
        <summary>Thinking</summary>
        <pre className="whitespace-pre-wrap">{part.text}</pre>
      </details>
    )
  return null
})}
```

**Sources 渲染示例**（Perplexity 风格）：

```tsx
{message.parts
  .filter((p) => p.type === "source-url")
  .map((p) => (
    <a key={p.id} href={p.url} target="_blank" rel="noopener noreferrer">
      [{p.title ?? new URL(p.url).hostname}]
    </a>
  ))}
```

### 2.7 无障碍与可访问性（WCAG 对齐）

| 要求 | 实现方式 |
|------|----------|
| **键盘导航** | 输入框、发送按钮、Stop 按钮可 Tab 聚焦，Enter 发送 |
| **ARIA 属性** | `role="log"` 消息列表、`aria-live="polite"` 流式区域 |
| **屏幕阅读器** | 新消息时 `aria-live` 播报，加载状态 `aria-busy` |
| **焦点管理** | 发送后焦点回到输入框，Stop 后焦点到 Stop 按钮 |
| **错误提示** | `role="alert"` 错误区域，`aria-describedby` 关联 |

### 2.8 欢迎空状态与快捷提示词（Suggested Prompts）

主流产品在无消息时展示欢迎区域和预设提示词，降低认知负荷（Hick 定律）：

- **布局**：居中展示欢迎文案 + 2–4 个快捷提示词按钮（如「写一封邮件」「总结这篇文章」「解释这段代码」）
- **交互**：点击快捷提示词后，将内容填入输入框或直接发送
- **实现**：主区域中央，当 `messages.length === 0` 时渲染 `chat-welcome.tsx`

### 2.9 Mock 开发策略

在后端 chat-service 未就绪时，前端可先使用 Mock 或占位接口开发：

- **方式 A（推荐）**：Vite 代理到占位接口（如返回固定 SSE 的 Node 脚本），与现有 `vite.config.ts` 中 `/api` 代理配置一致，开发时临时将 `/api/chat` 指向 Mock 服务
- **方式 B**：环境变量切换 API 地址，开发时 `VITE_CHAT_API` 指向 Mock 服务（如 json-server + 自定义 SSE 端点）

推荐方式 A，无需修改前端 Transport 配置，仅调整 Vite proxy 的 target 即可。

---

## 三、与后端接口契约（对接参考）

详见 [02-后端实现计划.md](./02-后端实现计划.md) 第三章。

**请求**：`POST /api/chat`，Body 含 `messages`、`conversationId`（可选）

**响应**：SSE 流式，Data Stream 协议（`text-start`、`text-delta`、`text-end`、`finish`、`[DONE]`）

---

## 四、Vite 代理配置

已有 [vite.config.ts](../../apps/web/vite.config.ts)：

```ts
proxy: {
  "/api": { target: "http://localhost:8080", changeOrigin: true }
}
```

确保 Chat 服务暴露 `POST /api/chat`，或由网关统一路由到 chat-service。

---

## 五、实施阶段建议

| 阶段 | 内容 | 预计 |
|------|------|------|
| **1. 前端基础** | 安装 AI SDK、实现 useChat + 基础 UI、Mock 或代理到占位接口 | 2-3 天 |
| **2. 前端完善** | 会话列表、持久化、Markdown 渲染、错误处理、Stop/Regenerate | 2-3 天 |
| **3. 主流 UI** | 侧边栏可折叠、会话重命名、欢迎空状态 + 快捷提示词、消息操作（复制/删除）、键盘快捷键 | 1-2 天 |

---

## 六、验收要点

### 6.1 核心功能

- 多轮对话、流式打字机效果
- 会话列表、新建/切换/删除会话
- JWT 鉴权、未登录跳转登录页
- 错误处理（网络、限流、Token 过期）
- Stop 停止生成、Regenerate 重新生成

### 6.2 主流趋势对齐

- 极简聊天窗口、可折叠侧边栏
- 会话重命名或自动生成标题
- 欢迎/空状态、快捷提示词（Suggested Prompts）
- 消息操作：复制、删除、👍/👎 反馈（可选）
- Markdown 渲染（代码高亮、表格等）
- 键盘快捷键：Enter 发送、Shift+Enter 换行
- 信任与预期管理：可选免责声明
- 优雅降级：错误态提供「重试」或「换个说法」按钮

### 6.3 设计与无障碍

- 符合设计系统（`@repo/ui`、Tailwind、主题变量）
- 响应式布局（移动端侧边栏可折叠）
- 键盘导航、ARIA 属性、屏幕阅读器友好

---

## 七、参考文档

| 文档 | 链接 |
|------|------|
| AI SDK Chatbot 指南 | [https://sdk.vercel.ai/docs/ai-sdk-ui/chatbot](https://sdk.vercel.ai/docs/ai-sdk-ui/chatbot) |
| useChat 参考 | [https://ai-sdk.dev/docs/reference/ai-sdk-ui/use-chat](https://ai-sdk.dev/docs/reference/ai-sdk-ui/use-chat) |
| OpenAI Apps SDK UI 指南 | [UI guidelines](https://developers.openai.com/apps-sdk/concepts/ui-guidelines) |
| 可信 AI 助手的 9 个 UX 模式 | [9 UX Patterns](https://orangeloops.com/2025/07/9-ux-patterns-to-build-trustworthy-ai-assistants/) |
| 项目 Vercel AI SDK 使用指南 | [vercel-ai-sdk-guide.md](./vercel-ai-sdk-guide.md) |
