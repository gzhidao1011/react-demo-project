# Chat 前后端联调指南

本文档指导完成 Chat 功能的前后端联调，确保前端（apps/web）与后端（chat-service）正确通信。

## 一、架构与数据流

```
前端 (Vite :5573)
    ↓ POST /api/chat (JWT + messages + conversationId)
Vite 代理 (/api → localhost:8080)
    ↓
API 网关 (:8080)
    ↓ lb://chat-service (Nacos 服务发现)
chat-service (:8003)
    ↓ JWT 校验、SSE 流式响应
```

## 二、环境准备

### 2.1 基础设施（Docker）

```bash
# 启动 MySQL、Nacos（chat-service 依赖）
docker-compose -f docker-compose.infra.yml up -d

# 或使用完整 compose
docker-compose up -d mysql nacos
```

### 2.2 数据库

- **MySQL**：端口 3306，root/root123
- **chat_db**：chat-service 首次启动时自动创建（`createDatabaseIfNotExist=true`）
- **nacos**：Nacos 使用 MySQL 存储配置，需先启动 MySQL

### 2.3 环境变量

**chat-service** 需配置 OpenAI API Key（可选，未配置时使用 Mock 模式）：

```bash
# .env 或系统环境变量
OPENAI_API_KEY=sk-xxx
OPENAI_MODEL=gpt-4o-mini  # 可选，默认 gpt-4o-mini
OPENAI_BASE_URL=https://api.openai.com  # 可选，代理/Azure 时覆盖
```

### 2.4 OpenAI 对接配置

chat-service 通过 **Spring AI** 对接 OpenAI，实现位于 `config/OpenAiChatConfig.java`、`service/impl/ChatServiceImpl.java`。

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|----------|--------|------|
| 模型切换 | `LLM_PROVIDER` | openai | `openai` \| `deepseek`，切换大模型 |
| **OpenAI** | | | |
| API Key | `OPENAI_API_KEY` | - | 必填（LLM_PROVIDER=openai 时） |
| 模型 | `OPENAI_MODEL` | gpt-4o-mini | 可选 |
| Base URL | `OPENAI_BASE_URL` | https://api.openai.com | 可选 |
| **DeepSeek** | | | |
| API Key | `DEEPSEEK_API_KEY` | - | 必填（LLM_PROVIDER=deepseek 时） |
| 模型 | `DEEPSEEK_MODEL` | deepseek-chat | 可选，支持 deepseek-reasoner |
| Base URL | `DEEPSEEK_BASE_URL` | https://api.deepseek.com | 可选 |
| 联网搜索 | `WEB_SEARCH_ENABLED` | false | 启用后 LLM 调用 web_search 工具 |
| Tavily API Key | `TAVILY_API_KEY` | - | 联网搜索必填（https://tavily.com） |

**Mock 模式**：当未配置对应 API Key 时，`ChatServiceImpl` 自动使用 Mock 流式响应（逐字返回），无需真实 LLM，便于本地开发与测试。

**Docker 部署**：`application-docker.yml` 已支持上述环境变量，在 `docker-compose` 中通过 `environment` 传入即可。

**JWT 配置**（与 user-service 共享公钥）：

- chat-service 使用 `classpath:keys/public.pem` 验证 JWT
- 确保 user-service 签发的 Token 使用相同公钥/私钥对

## 三、启动顺序

### 方式 A：经 API 网关（推荐，完整链路）

1. **启动基础设施**
   ```bash
   docker-compose -f docker-compose.infra.yml up -d
   ```

2. **启动 user-service**（用于登录获取 JWT）
   ```bash
   cd services && mvn spring-boot:run -pl user-service
   ```

3. **启动 chat-service**
   ```bash
   cd services && mvn spring-boot:run -pl chat-service
   ```

4. **启动 api-gateway**
   ```bash
   cd services && mvn spring-boot:run -pl api-gateway
   ```

5. **启动前端**
   ```bash
   pnpm -C apps/web dev
   ```

### 方式 B：直连 chat-service（快速联调）

当需快速验证 chat 功能、chat-service 未注册 Nacos 时，可将 `/api/chat` 直连 chat-service：

1. 在 `apps/web/.env` 中设置：
   ```
   VITE_CHAT_API_DIRECT=true
   ```

2. 启动 chat-service（端口 8003）
3. 启动 user-service、api-gateway（登录仍经网关）
4. 启动前端（Vite 会将 `/api/chat` 代理到 localhost:8003，其他 `/api/*` 仍走 8080）

## 四、认证流程

1. 访问 `/chat` 前需已登录
2. `(chat)/layout.tsx` 检查 `isAuthenticated()`，未登录则跳转 `/sign-in`
3. 登录成功后 `getAccessToken()` 返回 JWT，`useChat` 的 `headers` 注入 `Authorization: Bearer <token>`
4. chat-service 的 `JwtAuthFilter` 校验 Token，解析 `userId` 注入 `SecurityContext`

## 五、接口契约校验

### 5.1 请求格式（前端 → 后端）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| messages | UIMessage[] | 是 | AI SDK 格式，含 id、role、parts |
| conversationId | string | 否 | 会话 ID，用于持久化 |

**UIMessage 结构**：
```json
{
  "id": "msg_xxx",
  "role": "user",
  "parts": [{ "type": "text", "text": "你好" }]
}
```

### 5.2 响应格式（SSE Data Stream）

| 事件 | 说明 |
|------|------|
| start | 含 messageId |
| text-start | 含 id |
| text-delta | 含 id、delta |
| text-end | 含 id |
| finish | 可选含 conversationId、conversationTitle、usage |
| [DONE] | 流结束 |

### 5.3 前端 Transport 配置

`use-chat.ts` 中 `DefaultChatTransport`：
- `api: "/api/chat"`
- `headers`: 注入 `Authorization: Bearer ${token}`
- `body`: 注入 `conversationId`（与默认 messages 合并）

## 六、联调检查清单

- [ ] MySQL、Nacos 已启动
- [ ] chat-service 已启动并注册到 Nacos
- [ ] api-gateway 已启动（若经网关）
- [ ] user-service 已启动（登录）
- [ ] 前端已登录，sessionStorage 有 access_token
- [ ] 浏览器 Network 中 POST /api/chat 返回 200，响应类型为 `text/event-stream`
- [ ] 消息流式显示，无报错

## 七、常见问题

### 7.1 401 未授权

- 检查是否已登录，`getAccessToken()` 是否有值
- 检查 chat-service 与 user-service 的 JWT 公钥是否一致
- 检查 `Authorization` 头是否正确传递（网关会转发）

### 7.2 502 Bad Gateway / 503

- chat-service 未注册到 Nacos：确认 Nacos 控制台有 chat-service
- 网关路由配置：确认 `Path=/api/chat/**` 指向 `lb://chat-service`

### 7.3 流式响应不显示

- 检查响应头 `x-vercel-ai-ui-message-stream: v1`
- 检查 SSE 事件序列是否完整（start → text-start → text-delta → text-end → finish → [DONE]）
- 检查前端 `useChat` 是否使用 `DefaultChatTransport`（默认解析 Data Stream）

### 7.4 messages 格式不匹配

- 后端 `UIMessagePart` 需兼容 AI SDK 的 `{ id, role, parts: [{ type, text }] }`
- 若后端报 400，检查请求体是否包含 `messages` 数组

### 7.5 CORS

- 开发时 Vite 代理同源，无 CORS 问题
- 生产部署时需在网关或 chat-service 配置 CORS

## 八、验证步骤

1. 登录：访问 `/sign-in`，使用有效账号登录
2. 进入 Chat：跳转 `/chat`，应自动创建会话并跳转 `/chat/:id`
3. 发送消息：输入「你好」并发送
4. 观察：应看到流式打字机效果，AI 回复逐字显示
5. 停止/重试：测试「停止生成」「重新生成」按钮
6. 新建会话：点击侧边栏「新建对话」，验证多会话切换
