---
name: 用户与权限管理后台设计（后端）
overview: SSO + 独立认证服务后端方案：auth-service 与 user-service 职责、架构与 Token 流、数据模型与迁移、管理 API（REST、分页、软删除）、方法级鉴权、审计日志、限流、输入校验与安全、可观测；实施顺序与涉及文件。
todos: []
isProject: false
---

# 用户与权限管理后台设计（后端）

> 总览与术语表见 [README.md](README.md)。前端设计见 [前端.md](前端.md)。

## 一、国外主流做法对齐点（后端）

| 维度     | 常见做法                                   | 本方案采用                                                                 |
| -------- | ------------------------------------------ | -------------------------------------------------------------------------- |
| 模型     | RBAC：User – Role – Permission             | 是：用户-角色多对多，角色-权限多对多                                       |
| 权限粒度 | 资源+操作（如 `user:read`, `role:write`）   | 资源+操作（`resource:action`），与 Spring Security 一致                    |
| 接口风格 | REST + JSON，分页（offset 或 cursor）       | REST；分页优先 `page`/`size`，大列表可选 cursor（见 1.1）                  |
| 鉴权     | 仅管理员或特定权限可访问管理接口             | 方法级 `@PreAuthorize`（`hasRole('ADMIN')` 或 `hasAuthority('user:write')`） |
| Token    | 登录后 Token 携带角色/权限                  | JWT 带 `roles`，可选带 `permissions` 或仅后端按角色查权限                   |
| 删除策略 | 软删除 + 可恢复（合规与审计）               | 用户/角色软删除（`deleted_at`），列表默认过滤已删除（见 2.1）              |
| 审计     | 谁在何时对敏感资源做了何种操作（SOC2/GDPR） | 管理操作写审计日志（见 2.7），可选扩展：登录/登出/失败登录                 |
| 限流     | 认证与管理接口限流防滥用                   | 复用现有 `RATE_LIMIT_EXCEEDED`，429 响应头带 `Retry-After`（见 1.0）       |
| 幂等与并发 | 关键写操作幂等键、乐观锁防并发覆盖         | 可选：POST 支持 `Idempotency-Key`；PUT 支持 `version`/ETag（见 2.8）       |

### 1.0 错误响应与限流（与现有实现一致）

- **错误格式**：沿用现有 `{ code, message, data, errors? }`，与 [Result](services/api-common/src/main/java/com/example/api/common/Result.java) 一致；403 使用 [ResultCode.FORBIDDEN](services/api-common/src/main/java/com/example/api/common/ResultCode.java)，401 使用 UNAUTHORIZED/TOKEN_*；不暴露内部堆栈。
- **限流 429**：使用 [ResultCode.RATE_LIMIT_EXCEEDED](services/api-common/src/main/java/com/example/api/common/ResultCode.java)（42901）；响应头建议带 `Retry-After`（秒）和可选 `X-RateLimit-Limit`、`X-RateLimit-Remaining`，便于前端提示与重试（对齐 GitHub/Stripe）。
- **安全头**：Admin 与认证相关响应建议由网关或全局过滤器统一加 `X-Content-Type-Options: nosniff`、`X-Frame-Options`、CORS 白名单；若全站 HTTPS，可增加 `Strict-Transport-Security`（HSTS）。
- **403 与 404 语义**：**403 Forbidden** 表示已认证但无权限访问该资源；**404 Not Found** 表示资源不存在（或当前身份无权获知是否存在）。本方案默认采用 403/404 分离，便于前端区分“无权限”与“不存在”。

### 1.1 分页策略

- **Offset 分页**（`page`/`size`）：实现简单，适合后台表格、跳页；本方案**默认采用**，列表接口统一 `page`、`size`、`sort`。
- **Cursor 分页**（`cursor`/`limit`）：若将来用户量或角色量很大，可为 `GET /api/users`、`GET /api/roles` 增加可选参数 `cursor`+`limit`，响应中返回 `next_cursor`、`has_more`；与 `page`/`size` 二选一使用。

### 1.2 REST 与 HTTP 约定

- **HTTP 方法与语义**：`GET` 只读不写；`POST` 创建（返回 201 Created + `Location` 头）；`PUT` **全量替换**；`PATCH` **部分更新**（如仅更新角色、或恢复软删除）；`DELETE` 软删除（返回 200 或 204）。与 RFC 7231 及 GitHub/Stripe 习惯一致。
- **状态码**：200 成功；201 创建成功（Body + 可选 `Location: /api/users/{id}`）；204 No Content 用于无体的成功（如部分 DELETE）；400/401/403/404/409/429 与现有 [ResultCode](services/api-common/src/main/java/com/example/api/common/ResultCode.java) 一致。
- **分页响应结构**：列表接口统一采用**包裹式**：`{ "code": 0, "data": { "items": [...], "total": 100, "page": 1, "size": 20 } }`，与现有 [Result](services/api-common/src/main/java/com/example/api/common/Result.java) 一致。
- **Content-Type**：请求/响应 `Content-Type: application/json`；字符集 UTF-8。
- **时间格式**：API 中所有日期时间统一使用 **ISO 8601**（如 `2025-02-03T12:00:00Z` 或带时区 `+08:00`），与 Stripe、GitHub 一致。
- **列表无数据**：筛选后无结果时返回 **200** + `items: []`、`total: 0`，不返回 404。
- **默认排序**：未传 `sort` 时服务端使用默认排序（如 `createdAt,desc`），在 API 文档中写明。
- **405 Method Not Allowed**：资源存在但请求方法不被允许时返回 405，与现有 [ResultCode.METHOD_NOT_ALLOWED](services/api-common/src/main/java/com/example/api/common/ResultCode.java) 一致。

### 1.3 排序与筛选约定

- **排序**：列表接口统一 `sort` 参数，格式与 Spring Data / GitHub 习惯一致：`sort=field,asc` 或 `sort=field,desc`；多字段用逗号。服务端只接受白名单字段（如 `createdAt`、`email`、`name`）。
- **筛选**：筛选参数与资源语义一致，如 `email`、`name`、`role`、`deleted`。可选支持简单操作符或统一 `filter[field]=value`；首版可仅支持等值/包含。
- **白名单**：排序字段、筛选字段、每页最大 `size`（如 100）均做白名单或上限校验，防止滥用。

---

## 二、后端设计（auth-service + user-service）

### 2.0 架构总览与 Token 流（SSO + 独立认证服务）

- **auth-service（独立认证服务 / IdP）**  
  - 职责：注册、登录、刷新 Token、邮箱验证、密码重置；**仅此服务签发 JWT**（Access + Refresh）。  
  - 暴露：`/api/auth/**`；JWT 公钥暴露（如 `GET /.well-known/jwks.json` 或统一配置给网关/各服务）。  
  - 登录时：通过内部 API 调用 user-service 校验用户密码并拉取角色（见 2.0.1）；生成 JWT（sub=userId, roles=...）并返回。

- **user-service（用户与 RBAC）**  
  - 职责：用户 CRUD、角色/权限、RBAC 数据、管理 API、审计；**不再签发 JWT**。  
  - 接收：带 JWT 的请求；自身或网关校验 JWT（auth-service 公钥），解析 sub/roles 后做方法级鉴权。  
  - 对外：对 auth-service 提供“按 userId 查角色”的内部 API（校验用户、返回角色）。

- **API 网关**  
  - `/api/auth/**` → **auth-service**；`/api/users/**`、`/api/user/**` → **user-service**；`/api/chat/**` 等 → 对应业务服务。  
  - 可选：网关统一校验 JWT（auth-service 公钥）并转发 `X-User-Id`、`X-Roles`。

- **Token 流**  
  1. 前端登录：`POST /api/auth/login` → 网关 → auth-service → 校验用户 → 拉取角色 → 签发 JWT → 返回前端。  
  2. 业务请求：前端带 `Authorization: Bearer <access_token>` → 网关 → user-service/chat-service；网关或各服务校验 JWT，解析 sub/roles。  
  3. 刷新：`POST /api/auth/refresh` → 网关 → auth-service → 签发新 Access Token（可再次拉取角色以保持最新）。

**2.0.1 用户数据来源（auth-service 如何校验用户）**  
auth-service 通过 **内部 API** 调用 user-service 校验用户并拉取角色；用户数据**唯一归属 user-service**。与 Auth0/Keycloak/Stripe 等“认证服务不拥有用户数据、通过 API 与身份源协作”的做法一致，服务边界清晰，利于独立演进、独立部署与换库。

### 2.1 数据模型与迁移（user-service）

- **表结构**（Flyway 新迁移脚本，如 `V5__rbac_roles_permissions.sql`）：
  - `roles`：id, name, code（唯一，如 `ADMIN`/`USER`）, description, created_at, updated_at, **deleted_at**（软删除，NULL 表示未删除）
  - `permissions`：id, resource, action, description（唯一约束 (resource, action)）；通常只读/预定义，可不做软删除
  - `user_roles`：user_id, role_id，主键 (user_id, role_id)，外键到 users(id)、roles(id)
  - `role_permissions`：role_id, permission_id，主键 (role_id, permission_id)
  - **users 表**：在现有字段基础上增加 **deleted_at**（软删除）；列表与唯一性校验默认排除 `deleted_at IS NULL`，按需提供“查看已删除”筛选。
- **唯一约束**：`users.email`、`roles.code` 在软删除场景下需考虑唯一性。主流做法为“仅对未删除记录唯一”，例如 PostgreSQL 部分唯一索引：`CREATE UNIQUE INDEX uq_users_email_active ON users (email) WHERE deleted_at IS NULL`；MySQL 8.0+ 可用表达式索引或应用层保证。角色 `code` 同理。
- **种子数据**：插入若干内置 permission（如 `user:read`, `user:write`, `role:read`, `role:write`），以及至少一个角色（如 `ADMIN`）并为其分配全部或部分权限；可选：通过配置或首次启动时创建默认 admin 用户并赋予 `ADMIN` 角色（避免无管理员）。

### 2.2 实体与 Mapper

- 新增 Entity：`RoleEntity`、`PermissionEntity`（含 `deleted_at` 用于软删除）；`UserEntity` 增加 `deleted_at`，不冗余存储角色，通过 `user_roles` 关联查询；可选 `AuditLogEntity` 对应 2.7 审计表。
- MyBatis：RoleMapper、PermissionMapper、UserRoleMapper、RolePermissionMapper（含根据 userId 查角色列表、根据 roleId 查权限列表等）；列表查询默认过滤 `deleted_at IS NULL`，按需提供“含已删除”的查询。

### 2.3 认证服务（auth-service）设计

- **职责**：登录、注册、JWT 签发与刷新、邮箱验证、密码重置、Token 轮换与存储；**仅 auth-service 签发 JWT**。
- **登录时注入角色**：auth-service 在登录（及刷新时可选）通过内部 API 从 user-service 拉取当前用户的角色 code 列表（如 `["ADMIN","USER"]`），传入 `jwtService.generateAccessToken(..., roles)`；若需 JWT 内带权限列表，可再查 permissions 去重后写入 payload（可选）。
- **技术迁移**：从现有 user-service 迁移 AuthController、AuthService、JwtService、PasswordEncoder、邮箱发送、限流、Refresh Token 存储至新建 auth-service；auth-service 拥有自己的 JWT 密钥对（与各服务校验时使用的公钥一致）。
- **数据源**：通过内部 API 调用 user-service 校验用户并拉取角色；auth-service 不直接连用户库，用户数据唯一归属 user-service。
- **公钥暴露**：可选 `GET /.well-known/jwks.json` 或由配置中心/网关统一配置公钥，供 user-service、chat-service、网关校验 JWT。

### 2.4 管理 API 设计（REST，user-service）

- **用户管理**（需 admin 或相应权限）：
  - `GET /api/users`：分页 `page`, `size`，可选筛选 `email`/`name`/`role`/`deleted`，排序见 1.3（未传 `sort` 时默认如 `createdAt,desc`）；无结果时返回 200 + `items: []`、`total: 0`；返回含 `roles` 的 DTO；分页结构见 1.2（包裹式 `data.items` + `total`/`page`/`size`）。
  - `GET /api/users/{id}`：单用户详情（含角色列表）；若为软删除用户，可要求权限或仅 ADMIN 可查。
  - `POST /api/users`：创建用户（可指定初始角色）；成功返回 201 Created，响应头 `Location: /api/users/{id}`，Body 含新资源；支持 `Idempotency-Key`（见 2.8）。
  - `PUT /api/users/{id}`：更新用户与/或分配角色；可选乐观锁（version）。
  - `DELETE /api/users/{id}`：软删除用户（设置 `deleted_at`），成功建议返回 204 No Content；可选 `PATCH /api/users/{id}/restore` 恢复。
- **角色管理**：
  - `GET /api/roles`：分页列表，可选筛选 `deleted`，排序见 1.3；无结果时 200 + `items: []`、`total: 0`；分页结构同 1.2。
  - `GET /api/roles/{id}`：单角色详情（含权限列表）。
  - `POST /api/roles`：创建角色，成功返回 201 + `Location: /api/roles/{id}`；`PUT`/`DELETE`：更新/软删除角色；删除为软删除；**已实现** `PATCH /api/roles/{id}/restore` 恢复软删除角色（恢复时使用 `RoleMapper.findByIdIncludingDeleted` 查找已删除记录）。
  - `PUT /api/roles/{id}/permissions`：为角色绑定权限（幂等替换）；**已实现**，调用后写入审计 `role.permissions.updated`，集成测试见 `UserManagementControllerIntegrationTest#putRolePermissions_shouldUpdateAndWriteAudit`。
- **权限管理**：
  - `GET /api/permissions`：列表（可只读、预定义集合，或支持简单增删，视需求定）。

所有上述接口需通过 Spring Security 方法安全限制为具备相应角色或权限的请求（见下）。

### 2.5 安全配置与方法安全（auth-service 与 user-service）

- **auth-service**：仅暴露 `/api/auth/**`，无需方法级鉴权（登录/注册等为匿名或自验）；限流、密码策略、Token 存储与轮换在此服务内配置。
- **user-service**：  
  - 对 `/api/users`、`/api/roles`、`/api/permissions` 保持 `.authenticated()`，**认证方式改为校验 auth-service 颁发的 JWT**（使用 auth-service 公钥，不再在本服务内签发 Token）。  
  - 启用方法安全：`@EnableMethodSecurity`；Controller 方法上使用 `@PreAuthorize("hasRole('ADMIN')")` 或 `@PreAuthorize("hasAuthority('user:read')")` 等。  
  - 返回 403 时与现有 [ResultCode.FORBIDDEN](services/api-common/src/main/java/com/example/api/common/ResultCode.java) 统一。**实现状态**：已在 [GlobalExceptionHandler](services/api-common/src/main/java/com/example/api/exception/GlobalExceptionHandler.java) 中处理 `AccessDeniedException`，返回 403 与 `ResultCode.FORBIDDEN`；集成测试见 `UserManagementControllerIntegrationTest#getUsers_withNonAdmin_shouldReturn403`。  
- **限流**：网关或各服务对 `/api/auth/**`（auth-service）、`/api/users`、`/api/roles`、`/api/permissions`（user-service）配置限流（如按 IP 或 user_id），超出时返回 429 与 [ResultCode.RATE_LIMIT_EXCEEDED](services/api-common/src/main/java/com/example/api/common/ResultCode.java)（42901）一致，响应头带 `Retry-After` 及可选 `X-RateLimit-*`。

### 2.6 API 网关

- [application.yml](services/api-gateway/src/main/resources/application.yml) 中：**`/api/auth/**` 指向 auth-service**（唯一签发 Token 的入口）；**`/api/users/**`、`/api/user/**` 指向 user-service**；`/api/chat/**` 等指向对应业务服务。
- 可选：网关增加统一 JWT 校验过滤器（使用 auth-service 公钥），校验通过后转发 `X-User-Id`、`X-Roles` 等；若网关不校验，则 user-service、chat-service 等自行校验 JWT。
- 若将来将管理接口前缀统一为 `/api/admin/**`，可在网关增加一条路由到 user-service。

### 2.7 审计日志（主流必选）

- **目的**：满足合规与运维需求（谁在何时对用户/角色/权限做了何种操作），对齐 SOC2、GDPR 等常见要求。
- **表结构**（可放在同一 Flyway 脚本或 `V6__audit_log.sql`）：  
`audit_logs`：id, actor_id（操作人 user_id）, actor_email, action（如 `user.created`/`user.updated`/`role.permissions.updated`）, resource_type（`user`/`role`/`permission`）, resource_id, old_value（JSON，可选）, new_value（JSON，可选）, ip_address, user_agent, created_at。
- **写入时机**：在 Service 层对用户/角色/权限的创建、更新、删除（含软删除）、分配角色/权限成功后，同步或异步写入一条审计记录；敏感字段（如密码）不写入 old_value/new_value。
- **实现状态**：已在 `UserManagementService` 中实现审计写入。写入时机：`createUser`/`updateUser`/`softDeleteUser`/`restoreUser`、`createRole`/`updateRole`/`softDeleteRole`/`restoreRole`、`setRolePermissions` 成功后调用 `writeAudit`；操作人从 `SecurityContextHolder` 获取（兼容 `String` 与 `UserDetails` 类型的 principal）；`userSnapshot`/`roleSnapshot` 脱敏，不写入密码等敏感字段。集成测试见 `UserManagementControllerIntegrationTest#postUser_shouldWriteAuditLog`。
- **查询**：可选提供 `GET /api/admin/audit-logs`（分页 + 按 actor/resource_type/时间筛选），仅对具备 `audit:read` 或 ADMIN 开放。
- **保留与合规**：审计日志保留期可配置（如 1 年），过期可归档或删除；敏感字段（密码、Token）不写入 old_value/new_value。**Actor 快照**：审计记录中的 actor_id、actor_email 为**操作时快照**，即使用户后续改名、删号或软删除也不回溯修改历史记录，满足合规与可追溯性（与 Stripe、Auth0 等一致）。

### 2.8 幂等与乐观锁（可选）

- **幂等键**（对齐 Stripe）：对 `POST /api/users`、`POST /api/roles` 等关键写操作，支持请求头 `Idempotency-Key: <uuid>`。服务端在同一 key 下短时间（如 24h）内：首次请求正常执行并缓存响应；重复请求返回 200 与首次响应体，不重复写库。key 过期后再次请求视为新请求。
- **乐观锁**：`User`/`Role` 实体增加 `version` 字段，`PUT` 更新时传入 `If-Match: <version>` 或 body 内 `version`；若当前资源 version 与请求不一致则返回 409 Conflict（可与 [ResultCode](services/api-common/src/main/java/com/example/api/common/ResultCode.java) 扩展 409xx），避免并发覆盖。

### 2.9 输入校验与安全（主流必选）

- **请求体验证**：所有 `POST`/`PUT`/`PATCH` 体使用 Bean Validation（`@Valid`），校验失败返回 400 与 [ResultCode.VALIDATION_ERROR](services/api-common/src/main/java/com/example/api/common/ResultCode.java)，错误详情放入 `errors` 数组（field + message），与现有 [GlobalExceptionHandler](services/api-common/src/main/java/com/example/api/exception/GlobalExceptionHandler.java) 一致。
- **请求体大小**：在网关或应用层限制请求体大小（如 1MB），防止 DoS；超大上传走单独端点与限流。
- **账户安全**：登录失败次数与锁定沿用现有 [ResultCode.ACCOUNT_LOCKED](services/api-common/src/main/java/com/example/api/common/ResultCode.java)；密码策略沿用 [PasswordPolicyService](services/user-service/src/main/java/com/example/user/service/PasswordPolicyService.java)，符合 NIST/OWASP 建议。
- **敏感操作**：敏感操作（如批量删除、角色权限变更）可要求二次确认或短效 Token（可选扩展），与 Stripe/Auth0 等“高危操作确认”一致。

### 2.10 可观测与运维（主流对齐）

- **健康检查**：对外提供健康端点（如 `/actuator/health` 或 `/health`），供网关/K8s 探活与就绪判断；管理接口不依赖健康端点鉴权，与云原生惯例一致。
- **Request ID / 关联 ID**：请求进入网关或 user-service 时生成 `X-Request-Id`（或 `traceId`），在响应头与审计日志中透传，便于排查与关联日志；与 Stripe、AWS、Google Cloud 等常见做法一致。
- **日志**：敏感数据（密码、Token、完整 PII）不写日志；管理操作与审计分离，审计写库，日志可结构化（JSON）便于采集。

---

## 三、实施顺序建议（后端）

1. **新建 auth-service**  
   - 从 user-service 迁移：登录、注册、JWT 签发与刷新、邮箱验证、密码重置、Token 轮换与存储（Refresh Token）。  
   - 迁移 JwtService、PasswordEncoder、邮箱发送、限流等；auth-service 拥有自己的 JWT 密钥对（可复用现有密钥或新生成，需与后续校验方一致）。  
   - 实现调用 user-service 内部 API 校验用户并拉取角色（用户数据唯一归属 user-service）。

2. **网关路由调整**  
   - `/api/auth/**` 指向 **auth-service**（不再指向 user-service）。  
   - 其余路由不变；网关可选增加统一 JWT 校验（auth-service 公钥）并转发用户信息。

3. **user-service 改造**  
   - 移除登录/注册/JWT 签发相关代码（或保留接口但委托 auth-service，不推荐重复实现）；保留用户 CRUD、RBAC、管理 API、审计。  
   - 所有需认证的接口改为**仅校验 JWT**（从请求头取 Token，用 auth-service 公钥校验）；不再生成 Token。  
   - 提供内部 API 供 auth-service 调用（校验用户、返回角色）。

4. **RBAC 与 Admin 后端**  
   - user-service 内 Flyway 迁移（roles/permissions/user_roles/role_permissions + users 的 deleted_at）+ 审计表（audit_logs）+ 种子数据 → Entity/Mapper（含软删除与审计写入）→ 管理 API（用户/角色/权限 CRUD + 分页 + 软删除/恢复）+ `@PreAuthorize` → 限流配置；auth-service 登录/刷新时从 user-service 内部 API 取角色写入 JWT。

**联调与验证（后端）**：创建首个 Admin 用户（脚本或种子）、验证 JWT 由 auth-service 签发且含角色、验证无权限用户访问管理 API 返回 403、验证软删除与恢复、验证审计记录写入。

### 3.1 测试与文档（后端）

- 管理 API 单测/集成测（含 403、分页、软删除）；可选契约测试（如 Spring Cloud Contract）保证前后端约定一致。
- 可选为管理接口提供 OpenAPI 3.0（Swagger），便于前端与第三方集成；与现有网关或 user-service 集成，仅对具备相应权限或内网开放。

### 3.2 上线前检查（后端）

- **安全**：管理接口均受方法级鉴权；无默认密码或测试账号暴露；CORS/安全头已配置；敏感接口限流已启用。
- **合规与审计**：审计日志已写入且敏感字段不落库；软删除与恢复流程可用；如需 GDPR，数据导出/删除流程已就绪。

---

## 四、涉及文件与引用（后端）

以下为本方案（**SSO + 独立认证服务**）的后端涉及文件。

- **auth-service（新建）**：  
  登录/注册/刷新/验证/重置 Controller、AuthService、JwtService、Token 存储、邮箱发送、限流；  
  配置：JWT 密钥、user-service 内部 API 地址（校验用户、拉取角色）；  
  暴露：`/api/auth/**`、可选 `GET /.well-known/jwks.json`。

- **user-service（改造）**：  
  移除或下线 AuthController/AuthService 中签发 Token 的逻辑；保留 UserMapper、用户 CRUD、RBAC（第二章）、管理 API、审计；  
  [services/user-service/src/main/java/com/example/user/](services/user-service/)（Entity、Mapper、Service、Controller）、  
  [SecurityConfig](services/user-service/src/main/java/com/example/user/config/SecurityConfig.java)、  
  [services/user-service/src/main/resources/db/migration/](services/user-service/src/main/resources/db/migration/)；  
  所有接口改为 JWT 校验（auth-service 公钥）；新增内部 API 供 auth-service 调用（校验用户、返回角色）。

- **api-gateway**：  
  `/api/auth/**` 路由至 **auth-service**；  
  [application.yml](services/api-gateway/src/main/resources/application.yml) 等；  
  可选：统一 JWT 校验过滤器（使用 auth-service 公钥）、转发 `X-User-Id`/`X-Roles`。

- **api-common**：  
  [ResultCode](services/api-common/src/main/java/com/example/api/common/ResultCode.java)、[Result](services/api-common/src/main/java/com/example/api/common/Result.java)、DTO 若放公共层；  
  审计：audit_logs 表与 AuditLog 实体/写入逻辑（可放在 user-service）；限流：网关或各服务对 `/api/auth/**`、`/api/users|roles|permissions` 的限流配置。

---

## 五、SSO 与独立认证服务改造方案（详细说明）

本章为本方案（**SSO + 独立认证服务**）的详细说明：认证与用户数据解耦，由**独立 auth-service** 统一负责登录/注册/JWT 签发，各业务服务仅校验 Token，实现多应用统一登录（SSO）。架构与 Token 流、实施顺序、涉及文件已分别见第二章 2.0、第三章、第四章。

### 5.1 目标与原则

- **目标**：实现 SSO（单点登录）+ 由**独立认证服务**统一颁发 JWT；多前端/多应用共用同一套登录与 Token，一次登录可访问所有授权应用。
- **原则**：认证服务（IdP）只负责身份与 Token 签发；用户与 RBAC 数据仍在 user-service，auth-service 登录时向 user-service 拉取角色并写入 JWT；业务服务不签发 Token，仅校验 Token 并解析 sub/roles。

### 5.2 架构选型

| 方案 | 说明 | 适用场景 |
|------|------|----------|
| **自建 auth-service** | 从当前 user-service 拆出登录/注册/JWT/刷新/验证/重置至新服务 auth-service；user-service 保留用户与 RBAC，不再签发 Token | 本方案推荐：可控、与现有技术栈一致、可复用现有 JWT/密码/邮箱逻辑 |
| **外部 IdP（Keycloak/Auth0/Okta）** | 接入 Keycloak 或 SaaS IdP，业务系统仅校验 IdP 颁发的 Token（OIDC/OAuth2） | 需要企业 SSO、多 IdP 联合、或希望认证完全外包时 |

下文按**自建 auth-service**展开；若选外部 IdP，则认证流程改为 OIDC 授权码等，与本章接口设计可部分复用（如 `/api/auth/me` 形态）。

### 5.3 整体架构与 Token 流

- **auth-service（独立认证服务）**  
  - 职责：注册、登录、刷新 Token、邮箱验证、密码重置；**仅此服务签发 JWT**（Access + Refresh）。  
  - 暴露：`/api/auth/**`；JWT 公钥暴露（如 `GET /api/auth/.well-known/jwks.json` 或统一配置给网关/各服务）。  
  - 登录时：通过内部 API 调用 user-service 校验用户名密码并拉取该用户的角色列表（见 2.0.1）；生成 JWT（sub=userId, roles=...）并返回。

- **user-service（用户与 RBAC）**  
  - 职责：用户 CRUD、角色/权限、RBAC 数据、管理 API、审计；**不再签发 JWT**。  
  - 接收：带 JWT 的请求；自身或网关校验 JWT，解析 sub/roles 后做方法级鉴权。  
  - 对外：对 auth-service 提供“按 userId 查角色”的内部 API（校验用户、返回角色）。

- **API 网关**  
  - `/api/auth/**` → **auth-service**（唯一签发 Token 的入口）。  
  - `/api/users/**`、`/api/user/**` → **user-service**。  
  - `/api/chat/**` 等 → 对应业务服务。  
  - 网关可选：统一校验 JWT（使用 auth-service 公钥）、并转发 `X-User-Id`、`X-Roles` 等；若网关不校验，则各服务自行校验 JWT。

- **Token 流**  
  1. 前端登录：`POST /api/auth/login` → 网关 → auth-service → 校验用户 → 拉取角色 → 签发 JWT → 返回前端。  
  2. 前端请求业务 API：带 `Authorization: Bearer <access_token>` → 网关 → user-service/chat-service；网关或各服务校验 JWT，解析 sub/roles。  
  3. 刷新：`POST /api/auth/refresh` → 网关 → auth-service → 校验 Refresh Token → 签发新 Access Token（可再次向 user-service 拉取角色以保持最新）。

### 5.4 用户数据来源（auth-service 如何校验用户）

auth-service 通过 **内部 API** 调用 user-service 校验用户并拉取角色；用户数据**唯一归属 user-service**。user-service 提供内部 API（如 `GET /internal/users/{id}/roles` 或 `POST /internal/auth/validate` 返回用户信息+角色），仅服务间调用；auth-service 登录时调用该 API 校验密码并拉取角色。与 Auth0/Keycloak/Stripe 等“认证服务不拥有用户数据、通过 API 与身份源协作”的做法一致，服务边界清晰，利于独立演进、独立部署与换库。

### 5.5 SSO 如何实现

- **同一主域多应用**：前端统一使用同一网关与 `/api/auth`；登录后 Access/Refresh Token 存内存或 Cookie（若 Cookie 则需 SameSite、Secure、HttpOnly），同主域下各子应用共享 Cookie 或共享前端存储的 Token，即实现 SSO。
- **跨域/多前端**：各前端仍调用同一网关的 `/api/auth/login` 与 `/api/auth/refresh`，拿到同一套 JWT；Token 存各前端（如 localStorage 或 Cookie），不共享存储但**同一账号同一 Token 源**，视为 SSO（一次登录，多端可用）。若需严格“一次登录多域免登”，可再引入 OIDC 授权码 + 集中登录页与 redirect。
- **多后端服务**：所有业务服务统一校验 auth-service 签发的 JWT（公钥一致即可），无需各服务自己登录，天然支持多服务 SSO。

### 5.6 术语（后端相关）

| 术语 | 说明 |
|------|------|
| **IdP** | Identity Provider，身份提供商；本方案中即 auth-service，负责认证并颁发 Token。 |
| **SSO** | Single Sign-On，单点登录；本方案中由同一 auth-service 为多应用颁发同一套 JWT，一次登录多端可用。 |
| **资源服务** | 本方案中 user-service、chat-service 等仅校验 Token、不签发 Token 的服务。 |

---

## 六、可选扩展（后端）

- **审计日志**：已纳入 2.7；后续可扩展登录/登出/失败登录记录、IP/User-Agent 解析、`GET /api/admin/audit-logs` 查询与导出。
- **MFA/2FA**：Admin 或高权限账户建议支持 TOTP（如 Google Authenticator），登录时二次验证；与现有 JWT 流程衔接（登录成功后要求 MFA challenge，通过后再发 Token）。
- **会话与 Token 管理**：`GET /api/auth/sessions` 列出当前用户活跃会话（设备、IP、最后活跃时间），`DELETE /api/auth/sessions/{id}` 撤销指定会话；Refresh Token 存储与会话关联便于撤销。
- **OIDC/Scopes**：若接入 OAuth2/OIDC，将 permission 映射为 scope 或在 Token 中带 scope。
- **API 版本**：若需长期兼容多版本，可在网关或 user-service 预留 `/api/v1/users` 等，当前可仍用 `/api/users`。
- **多租户**：若未来有租户，可在 roles/user_roles 上增加 tenant_id 维度。
- **GDPR 数据主体权利**：若面向欧盟用户，可扩展“数据导出”（用户导出个人数据 JSON/CSV）与“被遗忘权”（硬删除或匿名化 + 审计记录）；与软删除、审计日志配合，满足合规。
- **HATEOAS / Links**（可选）：响应中可选带 `_links` 或 `links`（如 `self`、`next`、编辑链接），便于客户端发现与跳转，与 GitHub HAL 风格一致；首版可不做，后续按需加。
- **稀疏字段集**（可选）：列表或详情支持 `fields=id,email,name` 或 `include=roles` 减少 payload，与 JSON:API 稀疏字段集类似；首版可返回固定 DTO，后续按需扩展。
- **API 弃用与 Sunset**（可选）：弃用某接口时响应头带 `Deprecation: true` 与 `Sunset: <date>`（RFC 8594），文档注明替代方式与迁移期，与 GitHub/Stripe 一致。
- **批量端点**（可选）：如 `POST /api/users/batch`（批量创建）、`PATCH /api/users/batch`（批量更新角色/状态），减少前端多次请求；限流与审计按单次批量请求计。
- **API 发现**（可选）：`GET /api` 或 `GET /api/v1` 返回 API 元信息（版本号、文档链接、健康端点），便于客户端与文档发现，与 GitHub/Stripe 根路径约定一致。
- **防重放**（可选）：对极高敏感写操作可校验请求时间戳或 nonce，防止重放；JWT 短期有效已降低风险，可按需扩展。
- **资源 ID 对外暴露**（可选）：对外 API 使用 **UUID** 或不可预测 ID（如 ULID、NanoID），避免自增 ID 枚举与信息泄露，与 Stripe、GitHub 等一致；若当前为自增 id，可在网关或 DTO 层做映射，或后续迁移。
- **CORS 预检**：对跨域请求正确响应 `OPTIONS`，并设置 `Access-Control-Max-Age` 减少预检请求；与 RFC 及浏览器行为一致。
