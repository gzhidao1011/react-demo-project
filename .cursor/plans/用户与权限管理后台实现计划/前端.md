---
name: 用户与权限管理后台设计（前端）
overview: Admin 后台前端方案：路由与布局、接口与类型、页面与组件、权限与 UI 控制、与后端约定（分页/筛选、429 重试、i18n、客户端重试）；实施顺序与涉及文件。
todos: []
isProject: false
---

# 用户与权限管理后台设计（前端）

> 总览与术语表见 [README.md](README.md)。后端设计见 [后端.md](后端.md)。

## 一、国外主流做法对齐点（前端）

| 维度 | 常见做法 | 本方案采用 |
|------|----------|------------|
| 前端 | 独立 Admin 区、列表+筛选+分页、按权限隐藏/禁用 | 独立 `/admin` 布局与路由，分页/筛选，PermissionGuard/路由守卫（见下） |

### 1.1 前端 Admin 主流体验

- **面包屑**：Admin 布局内面包屑（如 Home / Users / Edit），便于层级与返回。
- **空状态与加载**：列表无数据时友好空状态（含引导操作）；列表/表单加载时骨架屏或 Skeleton。**首次引导**（可选）：首次进入 Admin 或某模块无数据时，可展示简短 Onboarding（如“创建第一个用户”引导），与 Vercel、Linear 等一致。
- **搜索与筛选**：搜索框防抖（如 300ms），筛选与 URL 查询参数同步（可分享、可书签）。**键盘快捷键**（可选）：列表页支持快捷键（如 `N` 新建、`/` 聚焦搜索、`Esc` 关闭弹窗），与 Linear、Notion 等 Admin 体验一致。
- **批量操作**（可选）：用户列表多选后批量分配角色、批量禁用/启用、批量导出；角色列表多选后批量删除（软删除）。
- **导出**：用户列表/角色列表支持导出 CSV（或 Excel），便于合规与运营；敏感字段按权限脱敏。
- **邀请用户**（可选扩展）：Admin 发起“邀请用户”，发邮件带 magic link 或临时密码，用户首次登录完善信息并改密，与现有注册/邮箱验证流程衔接。

---

## 二、前端设计（apps/web）

### 2.1 路由与布局

- 新增 Admin 布局（如 `(admin)/layout.tsx`）：侧栏菜单（用户管理、角色管理、权限管理）、顶部栏、主内容区；仅对“已登录且具备 admin 角色或相应权限”的用户可见。
- 路由（可放在 [extended.ts](apps/web/app/routes/extended.ts) 或新文件再合并）：
  - `/admin` → 重定向到 `/admin/users`
  - `/admin/users`：用户列表
  - `/admin/users/new`：新建用户
  - `/admin/users/:id`：编辑用户（含角色分配）
  - `/admin/roles`：角色列表
  - `/admin/roles/:id`：角色详情/编辑（含权限分配）
  - `/admin/permissions`：权限列表（只读或简单管理）
- 路由守卫：在加载 Admin 布局或各 Admin 子路由前，校验 Token 存在且（从 Token 解析或调用 `/api/auth/me`）包含 admin 角色或所需权限；不满足则重定向到登录或 403 页。

### 2.2 接口与类型（packages/services）

- 在 `packages/services` 中新增或扩展：
  - 类型：`User` 增加 `roles?: string[]`；`Role`、`Permission`；分页请求 `PageRequest`（`page`, `size`, `sort?`）；分页响应 `PageResponse<T>` 与后端约定一致（如 `{ items, total, page, size }` 或 `data`+ 元数据，见 [后端.md](后端.md) 1.2）。
  - API：getUserPage、getUserById、createUser、updateUser、deleteUser；getRolePage、getRoleById、createRole、updateRole、deleteRole、setRolePermissions；getPermissions。
- 所有请求通过现有 [api.service.base](packages/services/src/api.service.base.ts) 发起，自动带 Token；错误处理与 [handleServerError](packages/utils/src/form-errors.ts) 规范一致；收到 429 时若有 `Retry-After` 可提示用户或延迟重试。

### 2.3 页面与组件

- **用户列表**：表格展示 id、邮箱、姓名、角色（标签）、状态、最后登录/更新时间等；支持按邮箱/姓名/角色筛选、分页、防抖搜索；操作列：编辑、删除（软删除，带二次确认）、可选“恢复”对已删除用户；“新建用户”按钮；可选批量操作（多选后批量分配角色、批量导出 CSV）。
- **用户编辑/新建**：表单（邮箱、姓名、手机等）+ 角色多选；校验与错误展示遵循项目 [表单验证](.cursor/rules/09-表单验证.mdc) 与 [表单错误处理](.cursor/rules/10-表单错误处理.mdc)。
- **角色列表**：表格展示角色 code、名称、描述、权限数量；编辑、删除（软删除）、可选恢复；新建角色；可选批量删除、导出。
- **角色编辑**：名称、code、描述 + 权限多选（从 `GET /api/permissions` 拉取）。
- **权限列表**：只读表格（resource、action、描述），若后端支持可做简单新增/编辑。
- **体验细节**：Admin 布局内面包屑（如 Home / Users / Edit）；列表无数据时空状态与引导；列表/表单加载时骨架屏或 Skeleton；筛选与 URL 查询参数同步（可分享链接）；列表/表单错误时使用项目错误边界或局部 fallback，避免整页白屏。
- **可访问性**：管理界面按钮、表格、表单遵循 WCAG 2.1（焦点顺序、aria-label、role、键盘操作），与项目无障碍规范一致。
- 使用项目设计系统（Tailwind、主题变量、[设计系统](.cursor/rules/07-设计系统.mdc)），表格与表单组件可与现有 UI 包或 shadcn 等保持一致。Admin 界面文案与错误提示与项目 i18n（locale）衔接。

### 2.4 权限与 UI 控制

- 封装 `usePermissions`（或复用现有 skill 中的思路）：从 Token 或 `/api/auth/me` 取得 `roles`/`permissions`，提供 `hasRole`、`hasPermission`。
- `PermissionGuard`：根据 `requiredRole` 或 `requiredPermission` 决定是否渲染子组件（如按钮、菜单项）。
- Admin 菜单项与操作按钮按权限动态显示/隐藏，避免无权限用户看到入口。

### 2.5 前端与后端约定（主流对齐）

- **分页与筛选**：列表请求使用 `page`、`size`、`sort` 及筛选参数（如 `email`、`role`、`deleted`）；响应解析 `data.items`（或约定字段）与 `data.total`/`data.page`/`data.size`，与后端包裹式一致（见 [后端.md](后端.md) 1.2）。
- **乐观更新**（可选）：列表内“启用/禁用”“分配角色”等轻量操作可先更新 UI 再发请求，失败时回滚并 Toast；删除等不可逆操作不做乐观更新，等接口成功后再从列表移除或刷新。
- **429 与重试**：收到 429 时展示“请求过于频繁”；若有 `Retry-After` 可在 UI 提示“请 X 秒后重试”或禁用按钮倒计时，避免用户盲目重试。
- **i18n**：Admin 文案使用统一 key 命名（如 `admin.users.title`、`admin.roles.edit`），与 [packages/i18n](packages/i18n/) 或 [apps/web/locales](apps/web/locales/) 衔接；日期、数字格式按当前 locale。
- **客户端重试与退避**：对 429、5xx 或网络错误，前端可采用指数退避重试（如 1s、2s、4s 上限 3 次），避免瞬时故障导致整页失败；与 [api.service.base](packages/services/src/api.service.base.ts) 或请求层统一封装，不散落各组件（对齐 AWS、Stripe 等客户端重试建议）。

---

## 三、实施顺序建议（前端）

1. **类型与 API 封装**：分页请求/响应类型、用户/角色/权限 API（getUserPage、getUserById、createUser、updateUser、deleteUser；getRolePage、getRoleById、createRole、updateRole、deleteRole、setRolePermissions；getPermissions）；与 [后端.md](后端.md) 管理 API 约定一致。
2. **Admin 布局与路由**：新建 `(admin)/layout.tsx`、路由（`/admin` → `/admin/users`，`/admin/users`、`/admin/users/new`、`/admin/users/:id`，`/admin/roles`、`/admin/roles/:id`，`/admin/permissions`）；路由守卫（Token + admin 角色或相应权限）。
3. **用户列表与编辑**：用户列表页（表格、筛选、分页、防抖搜索、空状态、骨架屏）；用户新建/编辑页（表单 + 角色多选）；筛选与 URL 同步。
4. **角色列表与编辑**：角色列表页；角色新建/编辑页（表单 + 权限多选）。
5. **权限列表**：权限列表页（只读或简单管理）。
6. **权限守卫与菜单显隐**：`usePermissions`、`PermissionGuard`；Admin 菜单项与操作按钮按权限显示/隐藏。
7. **Admin 文案与 i18n**：与 [packages/i18n](packages/i18n/) 或 [apps/web/locales](apps/web/locales/) 衔接，保持与现有 home/chat/settings 的 locale 一致。

**与后端的衔接**：登录/注册/刷新 baseURL 仍为网关，路径仍为 `/api/auth/**`，仅后端实际处理者由 user-service 变为 auth-service，前端可无感（若接口契约一致）。chat-service 等业务请求若已带 JWT，改为使用 auth-service 签发的 Token 即可。

**联调与验证（前端）**：验证前端守卫与按钮显隐、验证软删除与恢复在 UI 上的表现、验证分页与筛选与 URL 同步、验证 429 时 Retry-After 提示。

### 3.1 测试与文档（前端）

- Admin 关键流程 E2E（登录 → 用户列表 → 编辑/软删除 → 恢复）；列表分页与筛选与 URL 同步的单元/集成测。

### 3.2 上线前检查（前端）

- **体验与兼容**：分页、筛选、错误码与后端约定一致；429 带 `Retry-After` 时前端有提示；Admin 文案已 i18n，无硬编码中文/英文。

---

## 四、涉及文件与引用（前端）

以下为本方案（**SSO + 独立认证服务**）的前端涉及文件。

- **路由与布局**：  
  [apps/web/app/routes/](apps/web/app/routes/)（Admin 路由配置）、  
  [apps/web/app/(admin)/](apps/web/app/)（新建 Admin 布局与页面）。

- **接口与类型**：  
  [packages/services/src/](packages/services/src/)（User/Role/Permission 类型、getUserPage、getUserById、createUser、updateUser、deleteUser；getRolePage、getRoleById、createRole、updateRole、deleteRole、setRolePermissions；getPermissions；分页请求/响应类型）。  
  所有请求通过现有 [api.service.base](packages/services/src/api.service.base.ts) 发起，自动带 Token。

- **权限与工具**：  
  [packages/utils](packages/utils/)（Token/权限解析、usePermissions 若放此处）；  
  错误处理与 [handleServerError](packages/utils/src/form-errors.ts) 规范一致。

- **文案与 i18n**：  
  Admin 文案与 [packages/i18n](packages/i18n/) 或 [apps/web/locales](apps/web/locales/) 衔接，保持与现有 home/chat/settings 的 locale 一致。

**说明**：登录/刷新仍请求 `/api/auth/**`（经网关），无需改 URL；Token 存储与携带方式不变。Admin 与 RBAC 前端实现见第二章；与后端 API 的约定见 2.5。

---

## 五、可选扩展（前端）

- **邀请用户**：Admin 发起邀请 → 发邮件（magic link 或临时密码）→ 用户首次登录完善信息并改密；与现有注册/邮箱验证流程衔接。
- **管理员代登（Impersonation）**：Admin 可“以某用户身份”登录以便支持与复现问题；需审计记录且仅限特定角色，退出后恢复原身份；前端需提供入口与状态展示。
