# 扩展阶段：审计日志和监控

**预计时间**：3-4 天

## 概述

本阶段实现审计日志、安全事件检测和监控集成，提升系统可观测性和安全性。

## 9.1 审计日志功能

### 步骤 9.1.1：创建 AuditLog 实体

- 创建文件：`services/user-service/src/main/java/com/example/user/entity/AuditLog.java`
- 添加字段：`id`、`userId`、`action`、`ipAddress`、`userAgent`、`deviceId`、`result`、`errorMessage`、`createdAt`
- 创建数据库表
- 添加索引：`userId`、`action`、`createdAt`
- **验收标准**：实体创建成功，数据库表创建完成

### 步骤 9.1.2：创建 AuditLogService

- 创建文件：`services/user-service/src/main/java/com/example/user/service/AuditLogService.java`
- 实现 `log()` 方法（记录审计日志，异步写入）
- 实现 `getUserAuditLogs()` 方法（查询用户审计日志）
- 实现敏感信息脱敏（密码、Token 等）
- 使用消息队列异步写入（可选）
- **验收标准**：审计日志服务功能完整，单元测试通过

### 步骤 9.1.3：集成审计日志

- 在 `AuthController` 的所有接口中添加审计日志记录：
  - 注册：记录注册成功/失败
  - 登录：记录登录成功/失败
  - 密码重置：记录重置请求/成功
  - Token 刷新：记录刷新操作
  - 登出：记录登出操作
- **验收标准**：所有认证操作都记录审计日志

### 步骤 9.1.4：实现日志查询接口（可选）

- 在 `AuthController` 中添加 `GET /api/v1/auth/audit-logs`（查询审计日志）
- 添加分页和过滤功能
- 添加权限控制（仅管理员可访问）
- **验收标准**：日志查询接口功能正常

## 9.2 安全事件服务

### 步骤 9.2.1：创建 SecurityEventService

- 创建文件：`services/user-service/src/main/java/com/example/user/service/SecurityEventService.java`
- 实现 `detectAnomalousLogin()` 方法（检测异常登录：新设备、新IP、异常时间）
- 实现 `detectMultipleFailures()` 方法（检测多次失败尝试）
- 实现 `detectSuspiciousActivity()` 方法（检测可疑活动：频繁登录、批量注册）
- 实现告警通知（邮件、Webhook）
- **验收标准**：安全事件服务功能完整，单元测试通过

### 步骤 9.2.2：集成安全事件检测

- 在登录接口中调用 `detectAnomalousLogin()`
- 在登录失败时调用 `detectMultipleFailures()`
- 在注册接口中调用 `detectSuspiciousActivity()`
- **验收标准**：安全事件检测集成成功

## 9.3 监控集成

### 步骤 9.3.1：添加监控依赖

- 打开文件：`services/user-service/pom.xml`
- 添加 Micrometer 依赖（Prometheus）
- 添加 Spring Boot Actuator 依赖
- **验收标准**：依赖添加成功

### 步骤 9.3.2：配置监控指标

- 打开文件：`services/user-service/src/main/resources/application.yml`
- 配置 Actuator endpoints
- 配置 Prometheus metrics
- **验收标准**：监控配置成功

### 步骤 9.3.3：添加自定义指标

- 在 `AuthController` 中添加自定义指标：
  - `auth.login.attempts`（登录尝试次数）
  - `auth.login.success`（登录成功次数）
  - `auth.login.failure`（登录失败次数）
  - `auth.token.refresh`（Token 刷新次数）
- **验收标准**：自定义指标添加成功，可在 Prometheus 中查看

### 步骤 9.3.4：配置告警规则

- 创建 Prometheus 告警规则文件
- 配置告警：
  - 登录失败率 > 5%
  - API 响应时间 > 500ms
  - 错误率 > 1%
- **验收标准**：告警规则配置成功，告警正常触发

## 相关文件

- `services/user-service/src/main/java/com/example/user/entity/AuditLog.java` - 审计日志实体
- `services/user-service/src/main/java/com/example/user/service/AuditLogService.java` - 审计日志服务
- `services/user-service/src/main/java/com/example/user/service/SecurityEventService.java` - 安全事件服务
- `services/user-service/pom.xml` - 添加监控依赖
- `services/user-service/src/main/resources/application.yml` - 监控配置
- `services/user-service/src/main/java/com/example/user/controller/AuthController.java` - 集成审计日志和安全事件检测

## 依赖关系

- **依赖第二阶段**：需要后端 API 已实现
- **依赖监控工具**：需要 Prometheus/Grafana 配置完成

## 验收标准总结

- ✅ 实体创建成功，数据库表创建完成
- ✅ 审计日志服务功能完整，单元测试通过
- ✅ 所有认证操作都记录审计日志
- ✅ 日志查询接口功能正常
- ✅ 安全事件服务功能完整，单元测试通过
- ✅ 安全事件检测集成成功
- ✅ 依赖添加成功
- ✅ 监控配置成功
- ✅ 自定义指标添加成功，可在 Prometheus 中查看
- ✅ 告警规则配置成功，告警正常触发
