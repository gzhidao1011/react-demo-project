# 扩展阶段：设备管理和会话管理

**预计时间**：3-4 天

## 概述

本阶段实现设备管理和会话管理功能，允许用户查看和管理登录设备，提升账户安全性。

## 8.1 设备管理功能

### 步骤 8.1.1：创建 Device 实体

- 创建文件：`services/user-service/src/main/java/com/example/user/entity/Device.java`
- 添加字段：`id`、`userId`、`deviceId`、`deviceName`、`userAgent`、`ipAddress`、`location`、`lastActiveAt`、`createdAt`
- 创建数据库表
- **验收标准**：实体创建成功，数据库表创建完成

### 步骤 8.1.2：创建 DeviceService

- 创建文件：`services/user-service/src/main/java/com/example/user/service/DeviceService.java`
- 实现 `identifyDevice()` 方法（通过 User-Agent、IP 识别设备）
- 实现 `createOrUpdateDevice()` 方法（创建设备记录）
- 实现 `getUserDevices()` 方法（获取用户设备列表）
- 实现 `revokeDevice()` 方法（撤销设备 Token）
- 实现 `revokeOtherDevices()` 方法（撤销其他设备）
- **验收标准**：设备管理服务功能完整，单元测试通过

### 步骤 8.1.3：修改登录接口集成设备管理

- 修改 `AuthController.login()` 方法
- 调用 `DeviceService.identifyDevice()` 识别设备
- 调用 `DeviceService.createOrUpdateDevice()` 创建设备记录
- 将设备ID关联到 Refresh Token
- **验收标准**：登录时设备记录创建成功

### 步骤 8.1.4：实现设备管理接口

- 在 `AuthController` 中添加 `GET /api/v1/auth/devices`（获取设备列表）
- 在 `AuthController` 中添加 `DELETE /api/v1/auth/devices/{deviceId}`（登出指定设备）
- 在 `AuthController` 中添加 `POST /api/v1/auth/devices/revoke-others`（登出其他设备）
- 添加单元测试
- **验收标准**：设备管理接口功能正常，测试通过

## 8.2 会话管理功能

### 步骤 8.2.1：创建 Session 实体

- 创建文件：`services/user-service/src/main/java/com/example/user/entity/Session.java`
- 添加字段：`id`、`userId`、`deviceId`、`refreshTokenId`、`createdAt`、`lastActiveAt`、`expiresAt`
- 创建数据库表
- **验收标准**：实体创建成功，数据库表创建完成

### 步骤 8.2.2：创建 SessionService

- 创建文件：`services/user-service/src/main/java/com/example/user/service/SessionService.java`
- 实现 `createSession()` 方法（创建会话）
- 实现 `updateSessionActivity()` 方法（更新最后活动时间）
- 实现 `getUserSessions()` 方法（获取用户会话列表）
- 实现 `revokeSession()` 方法（撤销会话）
- **验收标准**：会话管理服务功能完整，单元测试通过

### 步骤 8.2.3：集成会话管理

- 修改登录接口：登录成功后创建会话
- 修改刷新接口：刷新 Token 时更新会话活动时间
- 修改登出接口：登出时撤销会话
- **验收标准**：会话管理集成成功

### 步骤 8.2.4：实现会话查询接口

- 在 `AuthController` 中添加 `GET /api/v1/auth/sessions`（获取会话列表）
- 添加单元测试
- **验收标准**：会话查询接口功能正常，测试通过

## 相关文件

- `services/user-service/src/main/java/com/example/user/entity/Device.java` - 设备实体
- `services/user-service/src/main/java/com/example/user/service/DeviceService.java` - 设备管理服务
- `services/user-service/src/main/java/com/example/user/entity/Session.java` - 会话实体
- `services/user-service/src/main/java/com/example/user/service/SessionService.java` - 会话管理服务
- `services/user-service/src/main/java/com/example/user/controller/AuthController.java` - 设备管理和会话管理接口

## 依赖关系

- **依赖第三阶段**：需要 Token 刷新机制已实现

## 验收标准总结

- ✅ 实体创建成功，数据库表创建完成
- ✅ 设备管理服务功能完整，单元测试通过
- ✅ 登录时设备记录创建成功
- ✅ 设备管理接口功能正常，测试通过
- ✅ 会话管理服务功能完整，单元测试通过
- ✅ 会话管理集成成功
- ✅ 会话查询接口功能正常，测试通过
