# 第四阶段：限流和安全

**预计时间**：2-3 天

## 概述

本阶段实现限流保护和安全响应头，防止恶意攻击和滥用，提升系统安全性。

## 4.1 限流服务实现

### 步骤 4.1.1：创建 RateLimitService

- 创建文件：`services/user-service/src/main/java/com/example/user/service/RateLimitService.java`
- 实现 `checkRateLimit()` 方法：
  - IP 限流：每 IP 每小时 100 次（使用 Redis 计数）
  - 用户限流：每用户每 15 分钟 5 次（使用 Redis 计数）
  - Key 格式：`rate_limit:login:ip:{ip}`、`rate_limit:login:user:{userId}`
  - TTL 设置：IP 限流 1 小时，用户限流 15 分钟
- 实现 `incrementRateLimit()` 方法（增加计数）
- **验收标准**：限流逻辑实现完整，单元测试通过

### 步骤 4.1.2：配置限流规则

- 打开文件：`services/user-service/src/main/resources/application.yml`
- 添加限流配置：
  ```yaml
  rate-limit:
    login:
      max-attempts-per-ip: 100
      max-attempts-per-user: 5
      ip-window-seconds: 3600
      user-window-seconds: 900
  ```

- **验收标准**：配置加载成功

### 步骤 4.1.3：集成限流到登录接口

- 修改 `AuthController.login()` 方法
- 在方法开始处调用 `RateLimitService.checkRateLimit()`
- 如果超过限流，返回 `RATE_LIMIT_EXCEEDED` 错误
- **验收标准**：登录接口限流生效，超过限制时返回错误

## 4.2 安全响应头

### 步骤 4.2.1：创建 SecurityHeadersFilter

- 创建文件：`services/user-service/src/main/java/com/example/user/config/SecurityHeadersFilter.java`
- 实现 Filter 接口
- 添加安全响应头：
  - `X-Content-Type-Options: nosniff`
  - `X-Frame-Options: DENY`
  - `X-XSS-Protection: 1; mode=block`
  - `Strict-Transport-Security: max-age=31536000`（HTTPS 时）
- 注册 Filter
- **验收标准**：安全响应头正确添加，测试通过

### 步骤 4.2.2：测试限流和安全措施

- 使用 Postman/curl 测试限流功能
- 验证超过限流时返回 429 错误
- 验证响应头包含安全头
- **验收标准**：限流和安全措施测试通过

## 相关文件

- `services/user-service/src/main/java/com/example/user/service/RateLimitService.java` - 限流服务
- `services/user-service/src/main/resources/application.yml` - 限流配置
- `services/user-service/src/main/java/com/example/user/config/SecurityHeadersFilter.java` - 安全响应头过滤器
- `services/user-service/src/main/java/com/example/user/controller/AuthController.java` - 集成限流

## 依赖关系

- **依赖第二阶段**：需要登录接口已实现
- **依赖 Redis**：需要 Redis 服务运行（用于限流计数）

## 验收标准总结

- ✅ 限流逻辑实现完整，单元测试通过
- ✅ 配置加载成功
- ✅ 登录接口限流生效，超过限制时返回错误
- ✅ 安全响应头正确添加，测试通过
- ✅ 限流和安全措施测试通过
