---
name: 密码重置（前端）
overview: 密码重置前端实现：忘记密码页、重置密码页，React Hook Form + Zod，与注册邮箱验证保持一致的架构模式。
todos:
  - id: 1
    content: 忘记密码页
    status: completed
  - id: 2
    content: 重置密码页
    status: completed
  - id: 3
    content: 可访问性
    status: completed
  - id: 4
    content: 人工恢复路径
    status: completed
isProject: false
---

# 密码重置 - 前端实现计划

> 后端实现见 [12a-密码重置-后端.md](./12a-密码重置-后端.md)

## 一、路由

- [routes/core.ts](apps/web/app/routes/core.ts)：新增
  - `layout("./(all)/forgot-password/layout.tsx", [route("forgot-password", "./(all)/forgot-password/page.tsx")])`
  - `layout("./(all)/reset-password/layout.tsx", [route("reset-password", "./(all)/reset-password/page.tsx")])`

## 二、忘记密码页（forgot-password）

- 新建 `apps/web/app/(all)/forgot-password/page.tsx`、`forgot-password/layout.tsx`
- 表单：邮箱输入框（`autoComplete="email"`）、提交按钮
- 提交前对 email 做 `trim()`、`toLowerCase()` 标准化
- 使用 React Hook Form + Zod：`forgotPasswordSchema`（email 必填、格式校验）
- 提交后调用 `authForgotPassword(email)`，成功显示「请查收邮件」提示，2 秒后可跳转 `/sign-in`
- 错误处理：`handleServerError` + Toast（仅系统级错误）
- **可访问性**：`aria-invalid`、`aria-describedby`、`role="alert"` 等（参考表单错误处理规范）
- 底部链接：「返回登录」
- **人工恢复入口（OWASP）**：提供「无法收到邮件？请联系支持」链接或说明，确保用户始终有账户恢复路径

## 三、重置密码页（reset-password）

- 新建 `apps/web/app/(all)/reset-password/page.tsx`、`reset-password/layout.tsx`
- **Referrer 策略（OWASP）**：在 `reset-password/layout.tsx` 的 `meta` 中增加 `{ name: "referrer", content: "no-referrer" }`、`{ name: "robots", content: "noindex, nofollow" }`
- **缓存策略**：重置页设置 `Cache-Control: no-store`，防止敏感页面被缓存（在 `reset-password/layout.tsx` 的 loader 或 root 的 headers 中设置）
- 从 `useSearchParams()` 读取 `token`、`email`
- **无 token**：显示「链接无效或已过期」，提供「返回登录」「忘记密码」入口
- **有 token**：**不自动调用 API**，显示「设置新密码」表单（新密码、确认密码），用户点击提交后才调用 `authResetPassword(token, newPassword)`
  - **成功**：toast 成功，2 秒后跳转 `/sign-in`
  - **失败**：显示错误；若 URL 含 `email` 可显示「重新发送重置邮件」按钮（调用 `authForgotPassword(email)`）
- 密码策略：与注册页一致（Zod schema 复用或新建 `resetPasswordSchema`）
- **可访问性**：表单含 `aria-invalid`、`aria-describedby`、`role="alert"`，支持键盘导航
- **密码强度指示器（可选）**：实时显示强度条，参考 Auth0、1Password

## 四、登录页修改

- [sign-in/page.tsx](apps/web/app/(all)/sign-in/page.tsx)：将「忘记密码」链接从 `href="#"` 改为 `Link` 或 `navigate("/forgot-password")`

## 五、服务层

- [auth.service.ts](packages/services/src/auth.service.ts)：新增
  - `authForgotPassword(email: string): Promise<void>`（调用前对 email 做 `trim().toLowerCase()`）
  - `authResetPassword(token: string, newPassword: string): Promise<void>`（**不传 email**，后端仅依赖 token）

## 六、国际化

- [zh.json](apps/web/locales/zh.json)、[en.json](apps/web/locales/en.json)：新增
  - `auth.forgotPasswordTitle`、`auth.forgotPasswordDesc`
  - `auth.resetPasswordTitle`、`auth.resetPasswordDesc`、`auth.setNewPassword`
  - `auth.resetPasswordSuccess`、`auth.resetPasswordFailed`
  - `auth.checkEmailForReset`、`auth.resendResetEmail`、`auth.resendResetEmailSuccess`
  - `auth.passwordResetConfirmed`（确认邮件主题/内容，如「您的密码已成功重置」）
  - `auth.resetLinkExpiryNotice`（重置邮件中链接有效期说明，如「此链接 1 小时内有效」）
  - `auth.resetNotYouNotice`（确认邮件中安全提示，如「若非本人操作请立即联系支持」）
  - `auth.backToSignIn`、`auth.resetLinkInvalid`、`auth.resetLinkInvalidDesc`
  - `auth.cannotReceiveEmail`（无法收到邮件？请联系支持）

---

## 关键文件清单（前端）

| 层级     | 操作 | 文件 |
| -------- | ---- | ---- |
| 前端     | 修改 | `routes/core.ts`、`sign-in/page.tsx`、`auth.service.ts`、`zh.json`、`en.json` |
| 前端     | 新建 | `forgot-password/page.tsx`、`forgot-password/layout.tsx`、`reset-password/page.tsx`、`reset-password/layout.tsx` |
| packages | 修改 | `@repo/schemas`（可选，新增 `forgotPasswordSchema`、`resetPasswordSchema`） |

---

## 前端验收标准

- 忘记密码：输入邮箱后显示「请查收邮件」，无论邮箱是否存在均返回相同成功消息
- 重置密码：点击邮件链接进入重置页，输入新密码提交后成功，跳转登录页
- 无效/过期 token：显示「链接无效或已过期」（不区分无效/过期），提供重新发送入口
- Referrer 策略：重置页 HTML 包含 `referrer: no-referrer`、`robots: noindex, nofollow`
- 缓存策略：重置页响应头含 `Cache-Control: no-store`
- 人工恢复入口：忘记密码页提供「无法收到邮件？请联系支持」链接
- 可访问性：表单含 `aria-invalid`、`aria-describedby`、`role="alert"`，支持键盘导航

---

## 要实现的功能计划（前端）

| 阶段   | 序号 | 功能             | 实现要点                                                                 | 状态 |
| ------ | ---- | ---------------- | ------------------------------------------------------------------------ | ---- |
| 第一阶段 | 1    | 忘记密码页       | forgot-password 表单，React Hook Form + Zod，handleServerError             | ✅ |
| 第一阶段 | 2    | 重置密码页       | reset-password 表单，Referrer/robots 策略，Cache-Control: no-store        | ✅ |
| 第一阶段 | 3    | 可访问性         | 表单含 `aria-invalid`、`aria-describedby`、`role="alert"`，支持键盘导航     | ✅ |
| 第一阶段 | 4    | 人工恢复路径     | 忘记密码页提供「无法收到邮件？请联系支持」链接                             | ✅ |
| 第二阶段 | 5    | CSRF 防护        | forgot/reset 表单提交时携带 CSRF token（框架内置或自定义）                 | 待实现 |
| 第二阶段 | 6    | 密码强度指示器   | 重置密码页实时显示强度条，参考 Auth0、1Password                            | 待实现 |
| 第二阶段 | 7    | CAPTCHA          | 限流触发时展示 reCAPTCHA v3 / Cloudflare Turnstile                         | 待实现 |

---

## 实现顺序建议（前端）

1. auth.service 新增方法 → forgot-password 页 → reset-password 页 → sign-in 链接 → 国际化
2. 可访问性（表单 ARIA 属性、键盘导航）→ 人工恢复路径（「无法收到邮件？请联系支持」）
3. 测试：前端页面测试；参考 OWASP WSTG 4.4.09 进行安全测试
4. **第二阶段**：CSRF 防护 → 密码强度指示器 → CAPTCHA
