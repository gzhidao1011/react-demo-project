---
name: 密码重置（后端）
overview: 密码重置后端实现：忘记密码、重置密码 API，PasswordResetService，限流，Resend 邮件，遵循 OAuth 2.0 与 OWASP 安全实践。
todos:
  - id: 1
    content: 忘记密码 API
    status: completed
  - id: 2
    content: 重置密码 API
    status: completed
  - id: 3
    content: 过期 Token 清理定时任务
    status: completed
isProject: false
---

# 密码重置 - 后端实现计划

> 前端实现见 [12b-密码重置-前端.md](./12b-密码重置-前端.md)

## 一、配置扩展

**application.yml** 新增密码重置相关配置：

```yaml
# Resend 邮件配置（已有，补充密码重置链接前缀说明）
resend:
  api-key: ${RESEND_API_KEY:}
  from: ${RESEND_FROM:onboarding@resend.dev}
  verification-link-base: ${APP_FRONTEND_URL:http://localhost:5573}  # 验证与重置链接共用；生产环境必须 https://

# 密码重置 Token 配置（可配置，高安全场景可缩短）
password-reset:
  token-expiry-minutes: 60  # 默认 1h；高安全可设为 15–30

# 限流配置（新增 forgot-password、reset-password）
rate-limit:
  # ... 已有 login、verify-email 配置 ...
  forgot-password:
    max-attempts-per-ip: 5       # 每 IP 每小时最多 5 次（防暴力枚举邮箱）
    max-attempts-per-email: 3    # 每邮箱每小时最多 3 次（防滥用）
    ip-window-seconds: 3600
    email-window-seconds: 3600
  reset-password:
    max-attempts-per-ip: 10      # 每 IP 每小时最多 10 次（防暴力枚举 token）
    ip-window-seconds: 3600
```

## 二、数据库迁移

**V4__add_password_reset.sql**（新建）：

```sql
-- 新建 password_reset_tokens 表
CREATE TABLE IF NOT EXISTS password_reset_tokens (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    token_hash VARCHAR(64) NOT NULL,
    expires_at DATETIME NOT NULL,
    created_at DATETIME NOT NULL,
    INDEX idx_token_hash (token_hash),
    INDEX idx_user_id (user_id),
    INDEX idx_expires_at (expires_at),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## 三、实体与 Mapper

- 新建 `PasswordResetTokenEntity`：`id`, `userId`, `tokenHash`, `expiresAt`, `createdAt`
- 新建 `PasswordResetTokenMapper` 及 XML：`insert`, `findByTokenHash`, `deleteByUserId`, `deleteById`, `deleteExpiredBefore(Datetime)`（用于定时清理）
- **过期 Token 清理**：定时任务（如每日 03:00）删除 `expires_at < NOW()` 的记录，避免表膨胀；可复用 `email_verification_tokens` 的清理逻辑；实现方式：Spring `@Scheduled` 或 Quartz 或 cron 调用 `PasswordResetTokenMapper.deleteExpiredBefore(now())`

## 四、api-common 新增 DTO

- `ForgotPasswordRequest`：`{ email: string }`（需 `@Email` 校验；后端收到后 `trim()`、`toLowerCase()` 标准化）
- `ForgotPasswordResponse`：`{ message: string }`（统一成功消息，用户枚举防护）
- `ResetPasswordRequest`：`{ token: string, newPassword: string }`（需密码策略校验；**不传 email**，后端仅依赖 token）

## 五、ResultCode 新增错误码

- `PASSWORD_RESET_TOKEN_INVALID` (40110)：重置链接无效或已过期（**错误消息一致性**：无效与过期均返回此码，不区分泄露信息）

## 六、PasswordResetService（新建）

- `forgotPassword(email)`：
  - **限流**：每 IP 每小时 5 次、每邮箱每小时 3 次
  - **用户枚举防护**：无论邮箱是否存在均返回成功，不泄露用户信息
  - **响应时间一致性（OWASP）**：无论邮箱是否存在，执行相同逻辑路径，避免快路径泄露。若用户存在需发邮件，可采用「先返回 200，再异步发邮件」或「固定延迟」确保响应时间一致
  - 若用户存在：删除该用户旧 token、生成 64 字符 cryptographically secure token、存 SHA-256 哈希、过期时间从配置读取（默认 1h）、调用 Resend 发邮件
  - **URL 构建**：`{verification-link-base}/reset-password?token=xxx&email=yyy`，仅从配置读取（防 Host Header Injection）
  - Resend 调用时传入 UUID 作为 idempotency key
- `resetPassword(token, newPassword)`：
  - 校验 token（SHA-256 哈希比对）、未过期
  - 密码需通过 `PasswordPolicyService` 校验
  - 更新用户密码（BCrypt）、删除 token
  - **撤销 Refresh Token**：默认撤销该用户所有 Refresh Token（需 TokenRotationService 支持按 userId 撤销），符合 OWASP「登出所有设备」建议
  - **重置成功确认邮件（OWASP）**：成功后调用 Resend 发送「密码已成功重置」确认邮件（**不发送新密码**），便于用户发现未授权修改

**Resend 邮件模板**：需准备两类模板——① 重置链接邮件（含 `{resetUrl}`、**链接有效期说明**如「此链接 1 小时内有效」）；② 确认邮件（仅告知密码已重置，不含新密码；若非本人操作请立即联系支持）

**审计日志（可选）**：记录 `forgot-password`、`reset-password` 成功/失败事件（IP、email 脱敏、时间），便于合规与安全分析

**URL 中 email 参数**：`/reset-password?token=xxx&email=yyy` 中 `email` 可选，仅用于前端预填「重新发送」按钮；后端 `resetPassword` 不依赖 URL 中的 email，仅校验 token

**MFA 不绕过（OWASP WSTG）**：若用户已启用 MFA，密码重置流程不得弱于主认证；重置成功后登录时仍需完成 MFA 验证

**CSRF 防护**：`forgot-password`、`reset-password` 表单使用框架内置 CSRF token（若项目采用 session-based CSRF 防护）；`reset-password` 因 token 在 URL 中，攻击面较小，但建议统一防护

**密码复用（可选）**：`resetPassword` 可校验新密码是否与当前密码相同，相同则拒绝；高安全场景可检查 NIST 建议的 breached password 列表

## 七、RateLimitService 扩展

- `checkRateLimitForForgotPassword(ipAddress, email)`：按 IP 和邮箱限流
- `checkRateLimitForResetPassword(ipAddress)`：按 IP 限流（防暴力枚举 token）
- **IP 获取**：限流时 IP 优先从 `X-Forwarded-For` 取（若在负载均衡/反向代理后），否则用 `HttpServletRequest.getRemoteAddr()`

## 八、AuthController 新增接口

- `POST /api/auth/forgot-password`：请求体 `ForgotPasswordRequest`，返回 `Result<ForgotPasswordResponse>`；限流由 `PasswordResetService` 内部或 Controller 调用 `RateLimitService`；**幂等**：同一邮箱短时间内重复请求，仅发送一封邮件（或按限流拒绝）
- `POST /api/auth/reset-password`：请求体 `ResetPasswordRequest`，返回 `Result<Void>`；**限流**：调用 `RateLimitService.checkRateLimitForResetPassword(ipAddress)` 后再执行；**幂等**：同一 token 重复提交，首次成功后续返回 TOKEN_INVALID（因 token 已删除）

## 九、开发环境兜底

- `RESEND_API_KEY` 为空时：不调用 Resend，将重置链接打印到日志；确认邮件同样跳过（可打印到日志）；`TestTokenStore` 可扩展支持 `putPasswordReset(email, token)` 供测试使用
- **日志安全**：审计日志中 email 脱敏（如 `a***@example.com`），禁止记录 token 明文
- **Resend 失败处理**：发邮件失败时记录日志并告警；可配置重试次数（如 2 次）；失败不影响返回 200（用户枚举防护），但需监控

---

## 关键文件清单（后端）

| 层级       | 操作 | 文件 | 状态 |
| ---------- | ---- | ---- | ---- |
| 后端       | 修改 | `application.yml`（含 `password-reset.token-expiry-minutes`）、`AuthController.java`、`RateLimitService.java`、`UserMapper.java`（新增 `updatePassword`）、`UserMapper.xml`、`TokenRotationService.java`（新增 `revokeAllByUserId`）、`TestTokenStore.java`（新增 `putPasswordReset`/`getPasswordResetToken`）、`UserServiceApplication.java`（`@EnableScheduling`） | ✅ |
| 后端       | 新建 | `V4__add_password_reset.sql`、`PasswordResetTokenEntity.java`、`PasswordResetTokenMapper.java`（含 `deleteExpiredBefore`）、`PasswordResetTokenMapper.xml`、`PasswordResetService.java`、`PasswordResetTokenCleanupJob.java` | ✅ |
| api-common | 新建 | `ForgotPasswordRequest.java`、`ForgotPasswordResponse.java`、`ResetPasswordRequest.java` | ✅ |
| api-common | 修改 | `ResultCode.java`（新增 PASSWORD_RESET_TOKEN_INVALID 40110） | ✅ |

---

## 后端验收标准

- 忘记密码：无论邮箱是否存在均返回 200 + 相同成功消息
- 响应时间一致性：forgot-password 对存在/不存在邮箱的响应时间无明显差异
- 重置密码：校验 token 后更新密码、删除 token、撤销 Refresh Token
- 重置成功确认邮件：用户收到「密码已成功重置」邮件（不含新密码）
- 撤销 Refresh Token：重置成功后该用户其他设备会话失效
- 无效/过期 token：返回 PASSWORD_RESET_TOKEN_INVALID（不区分无效/过期）
- 限流生效：forgot-password 超限返回 429；reset-password 超限返回 429
- 开发环境无 API Key 时，重置链接输出到日志可正常测试
- 生产环境 `verification-link-base` 使用 `https://`
- 错误消息一致性：无效 token 与过期 token 返回相同错误码
- 幂等性：同一 token 重复提交，首次成功后续返回 TOKEN_INVALID
- 日志脱敏：审计日志中 email 脱敏，不记录 token 明文
- 过期 Token 清理：定时任务删除过期记录

---

## 要实现的功能计划（后端）

| 阶段   | 序号 | 功能             | 实现要点                                                                 | 状态 |
| ------ | ---- | ---------------- | ------------------------------------------------------------------------ | ---- |
| 第一阶段 | 1    | 忘记密码 API     | POST /auth/forgot-password，限流，用户枚举防护，响应时间一致性             | ✅ |
| 第一阶段 | 2    | 重置密码 API     | POST /auth/reset-password，token 校验，撤销 Refresh Token，确认邮件        | ✅ |
| 第一阶段 | 3    | 过期 Token 清理   | 定时任务删除 `password_reset_tokens` 中 `expires_at < NOW()` 的记录        | ✅ |
| 第二阶段 | 4    | 审计日志         | 记录 forgot-password、reset-password 成功/失败事件（IP、email 脱敏、时间） | 待实现 |
| 第二阶段 | 5    | CSRF 防护        | forgot/reset 接口支持 CSRF token（框架内置或自定义）                       | 待实现 |
| 第二阶段 | 6    | 密码复用校验     | resetPassword 拒绝新密码与当前密码相同                                     | 待实现 |
| 第二阶段 | 7    | CAPTCHA          | 限流触发时后端校验 reCAPTCHA v3 / Cloudflare Turnstile token              | 待实现 |
| 第二阶段 | 8    | 可信域名白名单   | 生产环境 `verification-link-base` 可扩展为域名白名单校验                   | 待实现 |
| 第二阶段 | 9    | breached password 检查 | 高安全场景可检查 NIST 建议的 breached password 列表                   | 待实现 |
| 第三阶段 | 10   | MFA 不绕过       | 若用户已启用 MFA，重置后登录仍需 MFA（若项目已支持 MFA）                   | 待实现 |

---

## 实现顺序建议（后端）

1. 数据库迁移 → 实体/Mapper → DTO → PasswordResetService → RateLimitService 扩展 → AuthController
2. 过期 Token 清理定时任务（可复用 email_verification 清理逻辑）
3. 测试：AuthControllerTest 集成测试；参考 OWASP WSTG 4.4.09 进行安全测试
4. **第二阶段**：审计日志 → CSRF 防护 → 密码复用校验 → CAPTCHA → 可信域名白名单 → breached password 检查
5. **第三阶段**：MFA 不绕过（若项目已支持 MFA）

---

## 实现记录（TDD 完成于 2026-02-02）

- **TDD 范式**：先编写 AuthControllerTest 中 forgot-password/reset-password 测试，再实现代码
- **测试覆盖**：`shouldForgotPasswordReturn200ForExistingEmail`、`shouldForgotPasswordReturn200ForNonExistingEmail`、`shouldResetPasswordSuccessfully`、`shouldResetPasswordFailWhenTokenInvalid`、`shouldResetPasswordFailWhenPasswordWeak`、`shouldResetPasswordReturnTokenInvalidOnSecondUse`、`shouldResetPasswordRevokeRefreshTokens`
- **关键修复**：UserMapper.updatePassword 需 `@Param` 注解；撤销后使用旧 refresh token 返回 40106 (REFRESH_TOKEN_REUSED)
- **Resend SDK**：4.0.0 版本 CreateEmailOptions.Builder 无 idempotencyKey 方法，已移除
