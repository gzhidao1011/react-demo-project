# 扩展阶段：密码重置和邮箱验证

**预计时间**：3-4 天

## 概述

本阶段实现密码重置和邮箱验证功能，提升用户体验和账户安全性。

> **邮箱验证已实现**：注册邮箱验证（Resend 硬验证模式）已按 [11-注册邮箱验证.md](./11-注册邮箱验证.md) 完整实现，包括后端 EmailVerificationService、前端 verify-email 页、sign-up/sign-in 页联动等。本节 7.1 为早期规划，实际实现以 11 为准。

## 7.1 邮箱验证功能

### 步骤 7.1.1：修改 UserEntity 添加邮箱验证字段

- 打开文件：`services/user-service/src/main/java/com/example/user/entity/UserEntity.java`
- 添加 `emailVerified` 字段：`private Boolean emailVerified = false;`
- 添加 `emailVerifiedAt` 字段：`private LocalDateTime emailVerifiedAt;`
- 创建数据库迁移脚本
- **验收标准**：字段添加成功，数据库迁移完成

### 步骤 7.1.2：创建 EmailVerificationService

- 创建文件：`services/user-service/src/main/java/com/example/user/service/EmailVerificationService.java`
- 实现 `generateVerificationToken()` 方法（生成验证 Token，有效期 24 小时）
- 实现 `sendVerificationEmail()` 方法（发送验证邮件）
- 实现 `verifyEmail()` 方法（验证邮箱，更新状态）
- 实现限流：每用户每小时 3 次
- **验收标准**：邮箱验证服务功能完整，单元测试通过

### 步骤 7.1.3：实现邮箱验证接口

- 在 `AuthController` 中添加 `POST /api/v1/auth/verify-email`（发送验证邮件）
- 在 `AuthController` 中添加 `GET /api/v1/auth/verify-email/{token}`（验证邮箱）
- 在 `AuthController` 中添加 `POST /api/v1/auth/resend-verification`（重新发送）
- 添加单元测试
- **验收标准**：接口功能正常，测试通过

## 7.2 密码重置功能

### 步骤 7.2.1：创建 PasswordResetService

- 创建文件：`services/user-service/src/main/java/com/example/user/service/PasswordResetService.java`
- 实现 `generateResetToken()` 方法（生成重置 Token，有效期 1 小时）
- 实现 `sendResetEmail()` 方法（发送密码重置邮件）
- 实现 `resetPassword()` 方法（重置密码，撤销所有 Token）
- 实现限流：每 IP 每小时 5 次，每用户每小时 3 次
- **验收标准**：密码重置服务功能完整，单元测试通过

### 步骤 7.2.2：创建 DTO

- 创建 `ForgotPasswordRequest.java`：`email` 字段
- 创建 `ResetPasswordRequest.java`：`token`、`newPassword` 字段
- **验收标准**：DTO 类创建成功

### 步骤 7.2.3：实现密码重置接口

- 在 `AuthController` 中添加 `POST /api/v1/auth/forgot-password`（忘记密码）
- 在 `AuthController` 中添加 `POST /api/v1/auth/reset-password`（重置密码）
- 安全措施：不明确提示邮箱是否存在
- 重置后撤销所有现有 Token
- 添加单元测试
- **验收标准**：接口功能正常，安全措施生效，测试通过

## 相关文件

- `services/user-service/src/main/java/com/example/user/entity/UserEntity.java` - 添加邮箱验证字段
- `services/user-service/src/main/java/com/example/user/service/EmailVerificationService.java` - 邮箱验证服务
- `services/user-service/src/main/java/com/example/user/service/PasswordResetService.java` - 密码重置服务
- `services/user-service/src/main/java/com/example/user/dto/ForgotPasswordRequest.java` - 忘记密码请求 DTO
- `services/user-service/src/main/java/com/example/user/dto/ResetPasswordRequest.java` - 重置密码请求 DTO
- `services/user-service/src/main/java/com/example/user/controller/AuthController.java` - 添加邮箱验证和密码重置接口

## 依赖关系

- **依赖第二阶段**：需要后端 API 已实现
- **依赖邮件服务**：需要邮件服务配置完成

## 验收标准总结

- ✅ 字段添加成功，数据库迁移完成
- ✅ 邮箱验证服务功能完整，单元测试通过
- ✅ 接口功能正常，测试通过
- ✅ 密码重置服务功能完整，单元测试通过
- ✅ DTO 类创建成功
- ✅ 接口功能正常，安全措施生效，测试通过
