# 第五阶段：前端集成

**预计时间**：4-5 天

## 概述

本阶段实现前端登录页面、Token 存储策略、Token 刷新机制和 API 集成，完成前后端联调。

## 5.1 Schema 修改

### 步骤 5.1.1：修改登录 Schema

- 打开文件：`packages/schemas/src/auth/login.schema.ts`
- 将 `username` 字段改为 `email`
- 使用 `emailSchema` 替代 `usernameSchema`
- 添加 `rememberMe` 字段：`z.boolean().optional()`
- **验收标准**：Schema 修改完成，类型定义正确

## 5.2 Token 存储策略

### 步骤 5.2.1：实现 Token 存储工具

- 打开文件：`packages/utils/src/auth.ts`
- 实现内存存储变量：`let accessTokenInMemory: string | null = null`
- 实现 `getAccessToken()` 方法：
  - 优先从内存读取
  - rememberMe 时从 localStorage 读取
- 实现 `setAccessToken()` 方法：
  - 存储到内存
  - rememberMe 时存储到 localStorage
- 实现 `getRefreshToken()`、`setRefreshToken()` 方法（localStorage）
- 实现 `clearAccessToken()`、`clearRefreshToken()` 方法
- 实现 `isTokenExpired()` 方法（检查 Token 是否即将过期）
- **验收标准**：Token 存储功能完整，单元测试通过

## 5.3 登录页面完善

### 步骤 5.3.1：修改登录页面

- 打开文件：`apps/web/app/(all)/sign-in/page.tsx`
- 修改表单 Schema 使用新的 loginSchema
- 添加"记住我"复选框：
  ```tsx
  <input type="checkbox" {...register("rememberMe")} />
  <label>记住我</label>
  ```

- 修改 `onSubmit` 函数：
  - 传递 `rememberMe` 参数到 API
  - 根据 `rememberMe` 决定 Token 存储策略
- 使用 `handleServerError` 处理错误
- 使用 `toast.success` 显示成功消息
- **验收标准**：登录页面功能完整，UI 正常，表单验证正确

## 5.4 Token 刷新机制

### 步骤 5.4.1：实现刷新队列

- 打开文件：`packages/services/src/api.service.base.ts`
- 添加刷新队列变量：
  ```typescript
  let isRefreshing = false
  let refreshSubscribers: Array<(token: string) => void> = []
  ```

- 实现 `subscribeTokenRefresh()` 方法（加入队列）
- 实现 `onTokenRefreshed()` 方法（通知队列）

### 步骤 5.4.2：实现刷新 Token 函数

- 实现 `refreshToken()` 函数：
  - 获取 Refresh Token
  - 调用 `POST /api/v1/auth/refresh` API
  - 不走拦截器，避免循环
  - 保存新 Token
  - 通知刷新队列
- **验收标准**：Token 刷新功能正常

### 步骤 5.4.3：实现请求拦截器

- 在 `api.service.base.ts` 中添加请求拦截器
- 自动添加 `Authorization: Bearer {token}` Header
- Token 即将过期时（剩余时间 < 5 分钟）自动刷新
- 刷新队列处理（等待刷新完成）
- **验收标准**：请求拦截器功能正常，自动刷新生效

### 步骤 5.4.4：实现响应拦截器

- 添加响应拦截器
- 处理 401 错误：
  - 尝试刷新 Token
  - 刷新成功后重试原请求
  - 刷新失败时清除 Token 并跳转登录页
- 自动保存登录响应的 Token
- Token 刷新后更新请求队列
- **验收标准**：响应拦截器功能正常，401 重试机制生效

## 5.5 API 集成

### 步骤 5.5.1：完善 auth.service.ts

- 打开文件：`packages/services/src/auth.service.ts`
- 定义 `LoginResponse` 接口（遵循 OAuth 2.0 格式）
- 修改 `authLogin()` 函数：
  - 返回类型为 `Promise<LoginResponse>`
  - 处理响应数据
- 修改 `authRegister()` 函数（如果需要）
- **验收标准**：API 调用正确，类型定义完整

### 步骤 5.5.2：测试完整流程

- 测试注册流程：填写表单 → 提交 → 验证错误处理 → 验证成功跳转
- 测试登录流程：填写表单 → 提交 → 验证 Token 存储 → 验证跳转
- 测试 Token 刷新：等待 Token 过期 → 验证自动刷新 → 验证请求重试
- 测试登出流程：点击登出 → 验证 Token 清除 → 验证跳转登录页
- **验收标准**：完整流程测试通过，所有功能正常

## 相关文件

- `packages/schemas/src/auth/login.schema.ts` - 登录 Schema
- `packages/utils/src/auth.ts` - Token 存储工具
- `apps/web/app/(all)/sign-in/page.tsx` - 登录页面
- `packages/services/src/api.service.base.ts` - API 基础服务（拦截器）
- `packages/services/src/auth.service.ts` - 认证服务

## 依赖关系

- **依赖第二阶段**：需要后端 API 已实现
- **依赖第三阶段**：需要 Token 刷新接口已实现

## 验收标准总结

- ✅ Schema 修改完成，类型定义正确
- ✅ Token 存储功能完整，单元测试通过
- ✅ 登录页面功能完整，UI 正常，表单验证正确
- ✅ Token 刷新功能正常
- ✅ 请求拦截器功能正常，自动刷新生效
- ✅ 响应拦截器功能正常，401 重试机制生效
- ✅ API 调用正确，类型定义完整
- ✅ 完整流程测试通过，所有功能正常
