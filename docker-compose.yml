# ==================== Docker Compose 配置 ====================
# 微服务架构完整部署配置
# 
# 使用方法：
#   启动所有服务：docker-compose up -d
#   启动基础设施：docker-compose up -d mysql nacos sentinel
#   先构建后启动：docker-compose up -d --build
#   查看日志：docker-compose logs -f [service-name]
#   停止服务：docker-compose down
#   清理数据：docker-compose down -v
#
# 注意：首次启动前需要先构建 jar 包：
#   cd services && mvn clean package -DskipTests
#
# chat-service 需配置 LLM API Key（可选，未配置时使用 Mock 模式）：
#   复制 services/.env.example 为 services/.env，填写 OPENAI_API_KEY 或 DEEPSEEK_API_KEY
#
# ============================================================

services:
  # ==================== 基础设施服务 ====================
  
  # MySQL 数据库
  mysql:
    image: mysql:8.0
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root123}
      TZ: Asia/Shanghai
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root123}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - microservices-network
    restart: unless-stopped

  # Nacos 注册中心/配置中心
  nacos:
    image: nacos/nacos-server:v2.3.0
    container_name: nacos
    environment:
      - MODE=standalone
      - PREFER_HOST_MODE=hostname
      - SPRING_DATASOURCE_PLATFORM=mysql
      - MYSQL_SERVICE_HOST=mysql
      - MYSQL_SERVICE_PORT=3306
      - MYSQL_SERVICE_DB_NAME=nacos
      - MYSQL_SERVICE_USER=root
      - MYSQL_SERVICE_PASSWORD=${MYSQL_ROOT_PASSWORD:-root123}
      - MYSQL_SERVICE_DB_PARAM=characterEncoding=utf8&connectTimeout=10000&socketTimeout=30000&autoReconnect=true&useSSL=false&allowPublicKeyRetrieval=true
      - NACOS_AUTH_ENABLE=false
      - JVM_XMS=256m
      - JVM_XMX=512m
    ports:
      - "8848:8848"
      - "9848:9848"
      - "9849:9849"
    volumes:
      - nacos-data:/home/nacos/data
      - nacos-logs:/home/nacos/logs
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8848/nacos/v1/console/health/readiness"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - microservices-network
    restart: unless-stopped

  # Sentinel 控制台
  sentinel:
    image: bladex/sentinel-dashboard:1.8.6
    container_name: sentinel
    environment:
      - JAVA_OPTS=-Dserver.port=8858 -Dcsp.sentinel.dashboard.server=localhost:8858
    ports:
      - "8858:8858"
    networks:
      - microservices-network
    restart: unless-stopped

  # Redis（Token 存储和缓存）
  redis:
    image: redis:7-alpine
    container_name: redis
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - microservices-network
    restart: unless-stopped

  # ==================== Java 微服务 ====================

  # 用户服务（多模块 Maven 项目，需要 ./services 作为 context）
  user-service:
    build:
      context: ./services
      dockerfile: user-service/Dockerfile
    image: microservices/user-service:latest
    container_name: user-service
    env_file:
      - ./services/.env  # 加载 Admin 初始化配置（ADMIN_INIT_*）
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=user_db
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD:-root123}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - DOCKER_HOST_IP=user-service
      - JAVA_OPTS=-Xms256m -Xmx512m
      # Admin 账号初始化配置（从 .env 文件加载）
      - ADMIN_INIT_ENABLED=${ADMIN_INIT_ENABLED:-true}
      - ADMIN_INIT_EMAIL=${ADMIN_INIT_EMAIL:-}
      - ADMIN_INIT_PASSWORD=${ADMIN_INIT_PASSWORD:-}
      - ADMIN_INIT_NAME=${ADMIN_INIT_NAME:-Administrator}
      - ADMIN_INIT_PHONE=${ADMIN_INIT_PHONE:-}
    ports:
      - "8001:8001"
      - "20880:20880"
    depends_on:
      mysql:
        condition: service_healthy
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - microservices-network
    restart: unless-stopped

  # 认证服务（注册、登录、JWT 签发与刷新，调用 user-service 内部 API）
  auth-service:
    build:
      context: ./services
      dockerfile: auth-service/Dockerfile
    image: microservices/auth-service:latest
    container_name: auth-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - INTERNAL_API_SECRET=${INTERNAL_API_SECRET:-change-me-internal-secret}
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - JAVA_OPTS=-Xms256m -Xmx512m
    ports:
      - "8002:8002"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      user-service:
        condition: service_started
    networks:
      - microservices-network
    restart: unless-stopped

  # 订单服务（多阶段构建，支持 Docker 内自动编译）
  order-service:
    build:
      context: ./services
      dockerfile: order-service/Dockerfile
    image: microservices/order-service:latest
    container_name: order-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=order_db
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD:-root123}
      - DOCKER_HOST_IP=order-service
      - JAVA_OPTS=-Xms256m -Xmx512m
    ports:
      - "8004:8002"
      - "20881:20881"
    depends_on:
      mysql:
        condition: service_healthy
      nacos:
        condition: service_healthy
      user-service:
        condition: service_started
    networks:
      - microservices-network
    restart: unless-stopped

  # Chat 服务（SSE 流式对话、LLM 对接、会话持久化）
  chat-service:
    build:
      context: ./services
      dockerfile: chat-service/Dockerfile
    image: microservices/chat-service:latest
    container_name: chat-service
    env_file:
      - ./services/.env  # LLM 配置（OPENAI_API_KEY、DEEPSEEK_API_KEY 等）
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=chat_db
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD:-root123}
      - DOCKER_HOST_IP=chat-service
      - LLM_PROVIDER=${LLM_PROVIDER:-deepseek}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - DEEPSEEK_MODEL=${DEEPSEEK_MODEL:-deepseek-chat}
      - DEEPSEEK_BASE_URL=${DEEPSEEK_BASE_URL:-https://api.deepseek.com}
      - WEB_SEARCH_ENABLED=${WEB_SEARCH_ENABLED:-false}
      - TAVILY_API_KEY=${TAVILY_API_KEY:-}
      - JAVA_OPTS=-Xms256m -Xmx512m
    ports:
      - "8003:8003"
    depends_on:
      mysql:
        condition: service_healthy
      nacos:
        condition: service_healthy
    networks:
      - microservices-network
    restart: unless-stopped

  # API 网关（多模块 Maven 项目，需要 ./services 作为 context）
  api-gateway:
    build:
      context: ./services
      dockerfile: api-gateway/Dockerfile
    image: microservices/api-gateway:latest
    container_name: api-gateway
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - SENTINEL_DASHBOARD=sentinel:8858
      - JAVA_OPTS=-Xms256m -Xmx512m
    ports:
      - "8080:8080"
    depends_on:
      nacos:
        condition: service_healthy
      auth-service:
        condition: service_started
      user-service:
        condition: service_started
      order-service:
        condition: service_started
      chat-service:
        condition: service_started
    networks:
      - microservices-network
    restart: unless-stopped

  # ==================== 前端应用 ====================

  # Web 应用（不暴露端口，仅内部访问）
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        APP_NAME: web
    image: microservices/web:latest
    container_name: web
    # 不暴露端口，仅通过反向代理访问
    expose:
      - "80"
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # 组件库 Storybook（不暴露端口，仅内部访问）
  storybook:
    build:
      context: .
      dockerfile: apps/storybook/Dockerfile
    image: microservices/storybook:latest
    container_name: storybook
    # 不暴露端口，仅通过反向代理访问
    expose:
      - "80"
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==================== 可观测性服务 ====================
  
  # Skywalking OAP
  skywalking-oap:
    image: apache/skywalking-oap-server:9.7.0
    container_name: skywalking-oap
    restart: unless-stopped
    environment:
      SW_STORAGE: h2
      SW_H2_DRIVER: org.h2.Driver
      SW_STORAGE_H2_DRIVER_PATH: -1
      SW_PROMETHEUS_FETCHER: default
      SW_PROMETHEUS_FETCHER_ACTIVE: "true"
    ports:
      - "11800:11800"  # gRPC采集端口
      - "12800:12800"  # HTTP查询端口
      - "9411:9411"    # Zipkin兼容端口
    volumes:
      - skywalking_data:/var/skywalking
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:12800/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Skywalking UI
  skywalking-ui:
    image: apache/skywalking-ui:9.7.0
    container_name: skywalking-ui
    restart: unless-stopped
    ports:
      - "8899:8080"
    environment:
      SW_OAP_ADDRESS: skywalking-oap:12800
      SW_LOG_LEVEL: info
    depends_on:
      skywalking-oap:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Prometheus 监控
  prometheus:
    image: prom/prometheus:v2.47.2
    container_name: prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    ports:
      - "9090:9090"
    volumes:
      - ./docker/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./docker/alert-rules.yml:/etc/prometheus/alert-rules.yml:ro
      - prometheus_data:/prometheus
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/-/healthy"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

  # Grafana 可视化
  grafana:
    image: grafana/grafana:10.2.0
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: Admin@123456
      GF_SECURITY_JWT_ENABLED: 'true'
      GF_SECURITY_JWT_HEADER_NAME: 'Authorization'
      GF_USERS_ALLOW_SIGN_UP: 'false'
      GF_LOG_LEVEL: info
      GF_PROVISIONING_PATH: /etc/grafana/provisioning
    volumes:
      - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana_data:/var/lib/grafana
    depends_on:
      prometheus:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Elasticsearch
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.10.2
    container_name: elasticsearch
    restart: unless-stopped
    environment:
      cluster.name: microservices-cluster
      discovery.type: single-node
      xpack.security.enabled: "false"
      ES_JAVA_OPTS: "-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - microservices-network
    healthcheck:
      test: curl --fail http://localhost:9200/_cluster/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 5

  # Logstash
  logstash:
    image: docker.elastic.co/logstash/logstash:8.10.2
    container_name: logstash
    restart: unless-stopped
    volumes:
      - ./docker/logstash.conf:/usr/share/logstash/pipeline/logstash.conf:ro
    ports:
      - "5000:5000/tcp"
      - "9600:9600"
    environment:
      LS_JAVA_OPTS: "-Xmx256m -Xms256m"
      LOG_LEVEL: info
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: curl --fail http://localhost:9600 || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

  # Kibana
  kibana:
    image: docker.elastic.co/kibana/kibana:8.10.2
    container_name: kibana
    restart: unless-stopped
    ports:
      - "5601:5601"
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
      KIBANA_DEFAULTAPPID: discover
      ELASTICSEARCH_USERNAME: ""
      ELASTICSEARCH_PASSWORD: ""
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: curl --fail http://localhost:5601/api/status || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== 前端反向代理 ====================

  # Nginx 反向代理（根据域名路由）
  nginx-proxy:
    image: nginx:alpine
    container_name: nginx-proxy
    ports:
      - "8888:80"  # 使用 8888 端口避免 Windows 端口冲突
      - "8443:443"  # HTTPS 支持（使用 8443 端口）
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro  # SSL 证书（可选）
    depends_on:
      - web
      - storybook
      - api-gateway
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

# ==================== 网络配置 ====================
networks:
  microservices-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ==================== 数据卷配置 ====================
volumes:
  mysql-data:
    driver: local
  nacos-data:
    driver: local
  nacos-logs:
    driver: local
  redis-data:
    driver: local
  skywalking_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  elasticsearch_data:
    driver: local
