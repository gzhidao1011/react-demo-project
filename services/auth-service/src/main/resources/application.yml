server:
  port: 8002  # 认证服务端口（与 user-service 8001 区分）

spring:
  application:
    name: auth-service
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: public
        group: DEFAULT_GROUP

  # Redis 配置（Token 存储和轮换）
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: 1  # 与 user-service 使用不同 db，避免冲突
      timeout: 3000

  # Kafka 配置 (Phase 2 事件驱动)
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
    consumer:
      group-id: auth-service-group
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: com.example.*

# Kafka Topic 配置
kafka:
  topics:
    user-created: user-created-events

# 健康检查与监控配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}

# JWT 配置（auth-service 签发 Token，私钥仅本服务持有）
jwt:
  algorithm: RS256
  private-key-path: classpath:keys/private.pem
  public-key-path: classpath:keys/public.pem
  access-token-expiration: 1800      # 30 分钟
  refresh-token-expiration: 604800   # 7 天
  issuer: ${JWT_ISSUER:https://auth.example.com}
  audience: ${JWT_AUDIENCE:api.example.com}

# 密码策略配置（与 user-service 一致）
password:
  min-length: 8
  require-uppercase: true
  require-lowercase: true
  require-digit: true
  require-special: true

# Resend 邮件配置（邮箱验证、密码重置）
resend:
  api-key: ${RESEND_API_KEY:}
  from: ${RESEND_FROM:onboarding@resend.dev}
  verification-link-base: ${APP_FRONTEND_URL:http://localhost:5573}

# 密码重置 Token 配置
password-reset:
  token-expiry-minutes: 60

# 限流配置
rate-limit:
  login:
    max-attempts-per-ip: 100
    max-attempts-per-user: 5
    ip-window-seconds: 3600
    user-window-seconds: 900
  verify-email:
    max-attempts-per-ip: 10
    ip-window-seconds: 3600
  forgot-password:
    max-attempts-per-ip: 5
    max-attempts-per-email: 3
    ip-window-seconds: 3600
    email-window-seconds: 3600
  reset-password:
    max-attempts-per-ip: 10
    ip-window-seconds: 3600

# 调用 user-service 内部 API（校验用户、创建用户、更新密码等）
user-service:
  internal:
    base-url: http://user-service  # 通过 Nacos 服务发现解析
    secret: ${INTERNAL_API_SECRET:change-me-internal-secret}
