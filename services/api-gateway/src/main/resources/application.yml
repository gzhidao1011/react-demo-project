server:
  port: 8080  # 网关端口

# 默认使用 Nacos 服务发现（lb://），需先启动 Nacos(localhost:8848) 及各服务并完成注册。
# 503 "Unable to find instance for auth-service" 时：说明未用 Nacos 或 auth-service 未注册。
# 本地无 Nacos 时请用 profile=local 启动网关（见 application-local.yml）：
#   cd services && mvn spring-boot:run -pl api-gateway -Dspring-boot.run.profiles=local
# 并先启动 auth-service(8002)、user-service(8001)。
# 默认禁用 Docker Compose，需先 make up 启动基础设施
# 使用 make gateway-compose 或 -Dspring-boot.run.profiles=docker-compose 可自动拉起
spring:
  docker:
    compose:
      enabled: false
  application:
    name: api-gateway
  cloud:
    gateway:
      # 全局超时配置
      httpclient:
        connect-timeout: 3000       # 连接超时 3 秒
        response-timeout: 10s       # 响应超时 10 秒
      routes:
        # 用户服务路由
        - id: user-service
          uri: lb://user-service  # lb 表示负载均衡，user-service 是服务名
          predicates:
            - Path=/api/users/**  # 匹配路径
          # 不使用 StripPrefix，直接转发完整路径 /api/users/** 到服务
        
        # 订单服务路由
        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/api/orders/**
          # 不使用 StripPrefix，直接转发完整路径 /api/orders/** 到服务
        # ✅ 认证相关路由（拆分后指向 auth-service）
        - id: auth-service
          uri: lb://auth-service
          predicates:
            - Path=/api/auth/**
        # 用户个人相关路由（locale 等，注意 /api/user 单数，与 /api/users 区分）
        - id: user-profile-service
          uri: lb://user-service
          predicates:
            - Path=/api/user/**
        # 角色管理路由
        - id: role-service
          uri: lb://user-service
          predicates:
            - Path=/api/roles/**
        # 权限管理路由
        - id: permission-service
          uri: lb://user-service
          predicates:
            - Path=/api/permissions/**
        # Chat 服务路由（SSE 流式响应需更长超时）
        - id: chat-service
          uri: lb://chat-service
          predicates:
            - Path=/api/chat/**
          metadata:
            response-timeout: 60000  # 60 秒（流式响应可能较长）

    nacos:
      discovery:
        server-addr: localhost:8848  # Nacos 服务器地址
        namespace: public
        group: DEFAULT_GROUP
    
    # Sentinel 配置
    sentinel:
      transport:
        port: 8719                    # Sentinel 客户端端口（与控制台通信）
        dashboard: localhost:8858     # Sentinel 控制台地址
      # 饥饿加载，启动时就连接控制台
      eager: true
      # Gateway 限流配置
      scg:
        fallback:
          mode: response              # 限流后返回响应
          response-status: 429        # HTTP 状态码 429 Too Many Requests
          response-body: '{"code": 429, "message": "请求过于频繁，请稍后再试", "success": false}'
          content-type: application/json;charset=UTF-8