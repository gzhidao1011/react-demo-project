server:
  port: 8001  # 服务端口

spring:
  config:
    import: optional:configserver:${CONFIG_SERVER_URI:http://localhost:8888}
  application:
    name: user-service  # 服务名称
  cloud:
    config:
      name: ${spring.application.name}
      profile: ${SPRING_PROFILES_ACTIVE:local}
      label: ${CONFIG_LABEL:main}
    nacos:
      discovery:
        server-addr: localhost:8848  # Nacos 服务器地址
        namespace: public  # 命名空间，默认 public
        group: DEFAULT_GROUP  # 分组，默认 DEFAULT_GROUP
  
  # 数据库配置
  datasource:
    url: jdbc:mysql://localhost:3306/user_db?useSSL=false&serverTimezone=Asia/Shanghai&characterEncoding=UTF-8&allowPublicKeyRetrieval=true
    username: root
    password: root123
    driver-class-name: com.mysql.cj.jdbc.Driver

  # Flyway 数据库迁移配置
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true  # 如果数据库已有表，将其标记为已迁移
    validate-on-migrate: true  # 迁移前验证迁移脚本
  
  # Redis 配置（Token 存储和轮换）
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: 0
      timeout: 3000  # 连接超时时间（毫秒）

  # Kafka 配置 (Phase 2 事件驱动)
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      acks: all
      retries: 3

# Kafka Topic 配置
kafka:
  topics:
    user-created: user-created-events

# Dubbo 配置
dubbo:
  application:
    name: user-service
    # 禁用应用级服务发现注册，避免与 Spring Cloud 服务发现冲突
    register-mode: interface  # 只注册接口级服务，不注册应用级服务
  registry:
    address: nacos://localhost:8848  # 使用 Nacos 作为注册中心
  protocol:
    name: dubbo
    port: 20880  # Dubbo 协议端口
  scan:
    base-packages: com.example.user.service  # 扫描服务实现类

# 健康检查与监控配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,refresh
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}

# JWT 配置
jwt:
  # 签名算法：RS256（非对称加密，推荐用于微服务架构）
  algorithm: RS256
  
  # RS256 密钥对路径
  private-key-path: classpath:keys/private.pem
  public-key-path: classpath:keys/public.pem
  
  # Token 有效期（秒）
  access-token-expiration: 1800      # 30 分钟
  refresh-token-expiration: 604800   # 7 天
  
  # 签发者和受众（可选）
  issuer: ${JWT_ISSUER:https://auth.example.com}
  audience: ${JWT_AUDIENCE:api.example.com}

# 密码策略配置
password:
  min-length: 8
  require-uppercase: true
  require-lowercase: true
  require-digit: true
  require-special: true

# Resend 邮件配置
resend:
  api-key: ${RESEND_API_KEY:}
  from: ${RESEND_FROM:onboarding@resend.dev}
  verification-link-base: ${APP_FRONTEND_URL:http://localhost:5573}

# 密码重置 Token 配置（可配置，高安全场景可缩短）
password-reset:
  token-expiry-minutes: 60  # 默认 1h；高安全可设为 15–30

# 限流配置
rate-limit:
  login:
    max-attempts-per-ip: 100      # IP 限流：每 IP 每小时最多 100 次
    max-attempts-per-user: 5      # 用户限流：每用户每 15 分钟最多 5 次
    ip-window-seconds: 3600       # IP 限流时间窗口（1 小时）
    user-window-seconds: 900      # 用户限流时间窗口（15 分钟）
  verify-email:
    max-attempts-per-ip: 10       # 验证接口限流：每 IP 每小时最多 10 次（防暴力枚举 token）
    ip-window-seconds: 3600
  forgot-password:
    max-attempts-per-ip: 5        # 每 IP 每小时最多 5 次（防暴力枚举邮箱）
    max-attempts-per-email: 3     # 每邮箱每小时最多 3 次（防滥用）
    ip-window-seconds: 3600
    email-window-seconds: 3600
  reset-password:
    max-attempts-per-ip: 10       # 每 IP 每小时最多 10 次（防暴力枚举 token）
    ip-window-seconds: 3600

# 内部 API 密钥（供 auth-service 调用 /internal/** 时携带 X-Internal-Secret）
internal:
  api:
    secret: ${INTERNAL_API_SECRET:change-me-internal-secret}

# Admin 账号初始化配置（符合国外主流做法：通过环境变量配置）
admin:
  initialization:
    enabled: ${ADMIN_INIT_ENABLED:true}  # 是否启用自动初始化（生产环境建议设为 false）
    email: ${ADMIN_INIT_EMAIL:}  # Admin 账号邮箱（必填，如果启用初始化）
    password: ${ADMIN_INIT_PASSWORD:}  # Admin 账号密码（必填，如果启用初始化）
    name: ${ADMIN_INIT_NAME:Administrator}  # Admin 账号姓名（可选，默认：Administrator）
    phone: ${ADMIN_INIT_PHONE:}  # Admin 账号手机号（可选）

# MyBatis 配置
mybatis:
  mapper-locations: classpath:mapper/**/*.xml
  type-aliases-package: com.example.user.entity
  configuration:
    map-underscore-to-camel-case: true